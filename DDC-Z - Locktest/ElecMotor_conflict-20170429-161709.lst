C51 COMPILER V9.54   ELECMOTOR                                                             04/29/2017 16:17:09 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE ELECMOTOR
OBJECT MODULE PLACED IN .\ElecMotor.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE ..\Library\ElecMotor.c COMPACT ROM(COMPACT) OPTIMIZE
                    -(8,SPEED) BROWSE INCDIR(..\Library) DEBUG OBJECTEXTEND PRINT(.\ElecMotor.lst) TABS(3) OBJECT(.\ElecMotor.obj)

line level    source

   1          /*---------------------------------------------------
   2             ElecMotor.c (v1.00)
   3             
   4             All programs related to Electric Motor in Main board
   5          ---------------------------------------------------*/ 
   6          
   7          #include "main.h"
   8          #include "port.h"
   9          
  10          #include "ElecMotor.h"
  11          #include "Delay.h"
  12          #include "communication.h"
  13          
  14          /*------- Public variable declarations -----------------*/
  15          extern tByte myTxRxData[7];
  16          
  17          bit CW_flag = 0;
  18          tByte Elecmotor_duration_G;
  19          bit ElecMotor_OC_flag = 0;
  20          bit ElecMotor_OC_flag2 = 0;
  21          tByte OC_count = 0;
  22          
  23          /*-------------------------------------------------------
  24             InitElecmotor()
  25          --------------------------------------------------------*/
  26          void InitElecmotor(void)
  27             {
  28   1         #ifdef Guxingzha
  29   1         ElecMotor_ACW();
  30   1         #endif
  31   1         
  32   1         #ifdef Suidongzha
              // ElecMotor_CW();
                 #endif
  35   1         }
  36             
  37          /*-------------------------------------------------------
  38             ElecMotor_CW()
  39             Electric Motor rotates clockwise.
  40          --------------------------------------------------------*/
  41          void ElecMotor_CW(void)
  42             {
  43   1         tByte i;
  44   1         
  45   1         lock_power = 1;   
  46   1            
  47   1         // ½«P0.2, PIN25ÉèÖÃÎª×¼Ë«ÏòÄ£Ê½
  48   1         P0M1 &= 0xfb;
  49   1         P0M2 &= 0xfb;
  50   1         wheeled_rotate = 0;
  51   1         
  52   1         // -----------------------------------------------
  53   1         ElecMotor_code();
  54   1      // Delay_100ms();
C51 COMPILER V9.54   ELECMOTOR                                                             04/29/2017 16:17:09 PAGE 2   

  55   1      // ElecMotor_code();
  56   1      
  57   1         MagentControl_1 = 1;
  58   1         MagentControl_2 = 0;
  59   1         ElecMotor_Delay_CW();
  60   1         MagentControl_1 = 1;
  61   1         MagentControl_2 = 1;
  62   1         
  63   1         for(i = 0; i < 7; i++)
  64   1            {
  65   2            #ifndef Locktest
  66   2            if(ElecMotor_OC_flag == 1)
  67   2               {
  68   3               ElecMotor_OC_flag = 0;
  69   3               // å…³é”2ç§’
  70   3               Delay_100ms();
  71   3               MagentControl_1 = 0;
  72   3               MagentControl_2 = 1;
  73   3               Delay_500ms();Delay_500ms();Delay_500ms();Delay_500ms();
  74   3               MagentControl_1 = 1;
  75   3               MagentControl_2 = 1;
  76   3               // å†æ¬¡å¼€é”
  77   3               Delay_100ms();Delay_100ms();
  78   3               ElecMotor_code();
  79   3               MagentControl_1 = 1;
  80   3               MagentControl_2 = 0;
  81   3               ElecMotor_Delay_CW();
  82   3               MagentControl_1 = 1;
  83   3               MagentControl_2 = 1;       
  84   3               }
  85   2            #endif
  86   2            
  87   2            #ifdef Locktest
                    if(OC_count >= 1)
                       Externalmotor = 0;
                    #endif
  91   2            }
  92   1         
  93   1         
  94   1         wheeled_rotate = 1;
  95   1         // ½«P0.2, PIN25ÉèÖÃÎª×¼Ë«ÏòÄ£Ê½
  96   1         P0M1 |= 0x04;
  97   1         P0M2 &= 0xfb;
  98   1         
  99   1         ElecMotor_OC_flag = 0;
 100   1      
 101   1         Externalmotor = 1;
 102   1         
 103   1         lock_power = 0;
 104   1         }
 105          
 106          /*-------------------------------------------------------
 107             ElecMotor_ACW()
 108             Electric Motor rotates anticlockwise.
 109          --------------------------------------------------------*/
 110          void ElecMotor_ACW(void)
 111             {
 112   1         tByte i;
 113   1         lock_power = 1;
 114   1            
 115   1         Externalmotor = 1;
 116   1         Lock_EN = 1;
C51 COMPILER V9.54   ELECMOTOR                                                             04/29/2017 16:17:09 PAGE 3   

 117   1         Generator_lock = 0;
 118   1         
 119   1         MagentControl_1 = 0;
 120   1         MagentControl_2 = 1;
 121   1         ElecMotor_Delay_ACW();
 122   1         MagentControl_1 = 1;
 123   1         MagentControl_2 = 1;
 124   1         
 125   1         ElecMotor_OC_flag2 = 0;
 126   1      
 127   1         for(i = 0; i < 7; i++)
 128   1            {
 129   2            #ifndef Locktest
 130   2            if(ElecMotor_OC_flag == 1)
 131   2               {
 132   3               ElecMotor_OC_flag = 0;
 133   3               // å¼€é”2ç§’
 134   3               Delay_100ms();
 135   3               ElecMotor_code();
 136   3               MagentControl_1 = 1;
 137   3               MagentControl_2 = 0;
 138   3               Delay_500ms();Delay_500ms();Delay_500ms();Delay_500ms();
 139   3               MagentControl_1 = 1;
 140   3               MagentControl_2 = 1;
 141   3               // å†æ¬¡å…³é”
 142   3               Delay_100ms();
 143   3               MagentControl_1 = 0;
 144   3               MagentControl_2 = 1;
 145   3               ElecMotor_Delay_ACW();
 146   3               MagentControl_1 = 1;
 147   3               MagentControl_2 = 1;
 148   3               }
 149   2            #endif
 150   2            
 151   2            #ifdef Locktest
                    if(OC_count >= 1)
                       Externalmotor = 0;
                    #endif
 155   2            }
 156   1         
 157   1         ElecMotor_OC_flag = 0;
 158   1            
 159   1            lock_power = 0;
 160   1         }
 161          
 162          /*--------------------------------------------------
 163             ElecMotor_code()
 164             send the code to Electric Motor.
 165          ---------------------------------------------------*/
 166          void ElecMotor_code(void)  
 167             {  
 168   1         tByte i,n;
 169   1         myTxRxData[0]=CmdHead;
 170   1         myTxRxData[1]=MyAddress;
 171   1         myTxRxData[2]=ComMode_1;
 172   1         
 173   1         for(i=0;i<3;i++)
 174   1            {
 175   2            for(n=0;n<8;n++)
 176   2               {
 177   3               if((myTxRxData[i]&0x80) == 0x80)
 178   3                  {
C51 COMPILER V9.54   ELECMOTOR                                                             04/29/2017 16:17:09 PAGE 4   

 179   4                  MagentControl_2 = 0;
 180   4                  Delay_12ms();
 181   4                  }
 182   3               else
 183   3                  {
 184   4                  MagentControl_2 = 0;
 185   4                  Delay_5ms();
 186   4                  }
 187   3               MagentControl_2 = 1; 
 188   3               myTxRxData[i] <<= 1;
 189   3               Delay_5ms();
 190   3               }
 191   2            }
 192   1         }
 193          
 194          /*--------------------------------------------------
 195             ElecMotor_closecode()
 196             send the code to Electric Motor.
 197          ---------------------------------------------------*/
 198          void ElecMotor_closecode(void)   
 199             {  
 200   1         tByte i,n;
 201   1         myTxRxData[0]=CmdHead;
 202   1         myTxRxData[1]=MyAddress;
 203   1         myTxRxData[2]=ComMode_2;
 204   1         
 205   1         for(i=0;i<3;i++)
 206   1            {
 207   2            for(n=0;n<8;n++)
 208   2               {
 209   3               if((myTxRxData[i]&0x80) == 0x80)
 210   3                  {
 211   4                  TXD = 0;
 212   4                  Delay_12ms();
 213   4                  }
 214   3               else
 215   3                  {
 216   4                  TXD = 0;
 217   4                  Delay_5ms();
 218   4                  }
 219   3               TXD = 1; 
 220   3               myTxRxData[i] <<= 1;
 221   3               Delay_5ms();
 222   3               }
 223   2            }
 224   1         }
 225          /*--------------------------------------------------
 226             ElecMotor_stopcode()
 227             send the code to Electric Motor.
 228          ---------------------------------------------------*/
 229          void ElecMotor_stopcode(void) 
 230             {  
 231   1         tByte i,n;
 232   1         myTxRxData[0]=CmdHead;
 233   1         myTxRxData[1]=MyAddress;
 234   1         myTxRxData[2]=ComMode_3;
 235   1         
 236   1         for(i=0;i<3;i++)
 237   1            {
 238   2            for(n=0;n<8;n++)
 239   2               {
 240   3               if((myTxRxData[i]&0x80) == 0x80)
C51 COMPILER V9.54   ELECMOTOR                                                             04/29/2017 16:17:09 PAGE 5   

 241   3                  {
 242   4                  TXD = 0;
 243   4                  Delay_12ms();
 244   4                  }
 245   3               else
 246   3                  {
 247   4                  TXD = 0;
 248   4                  Delay_5ms();
 249   4                  }
 250   3               TXD = 1; 
 251   3               myTxRxData[i] <<= 1;
 252   3               Delay_5ms();
 253   3               }
 254   2            }
 255   1         }
 256          
 257          /*----------------------------------------------------
 258             ElecMotor_Delay_CW()
 259             Delay program for Electric Motor.
 260          -----------------------------------------------------*/
 261          void ElecMotor_Delay_CW(void)
 262             {
 263   1         tWord zz;
 264   1         
 265   1         Delay_100ms(); Delay_100ms();Delay_100ms();  Delay_100ms();
 266   1         
 267   1      
 268   1         for(zz = 0; zz < 35; zz++)
 269   1            {
 270   2            if(ElecMotor_overcurrent == 1)
 271   2               ElecMotor_OC_flag = 1;
 272   2            
 273   2            if(ElecMotor_OC_flag == 0)
 274   2               Delay_10ms();
 275   2            }
 276   1         
 277   1         if(ElecMotor_OC_flag == 0)
 278   1            {
 279   2            Delay_500ms();
 280   2            #ifdef Old_lock   
                    Delay_500ms();
                    Delay_500ms();Delay_500ms();
                    Delay_500ms();Delay_500ms();Delay_500ms();
                    #endif
 285   2            }
 286   1      
 287   1      /* for(zz = 0; zz < 200; zz++)
 288   1            {
 289   1            if(ElecMotor_overcurrent == 1)
 290   1               ElecMotor_OC_flag = 1;
 291   1            
 292   1            if(ElecMotor_OC_flag == 0)
 293   1               Delay_10ms();
 294   1            }
 295   1      */ 
 296   1      // Delay_500ms();
 297   1      // Delay_500ms();
 298   1      // Delay_500ms();
 299   1      // Delay_500ms();
 300   1      // Delay_500ms();
 301   1      
 302   1      
C51 COMPILER V9.54   ELECMOTOR                                                             04/29/2017 16:17:09 PAGE 6   

 303   1      /* #ifdef Z3
 304   1         Delay_500ms();
 305   1         Delay_500ms();
 306   1         Delay_500ms();
 307   1         Delay_500ms();
 308   1         Delay_500ms();
 309   1         #endif
 310   1      */
 311   1         
 312   1         
 313   1         if(ElecMotor_OC_flag == 1)
 314   1            OC_count += 1;
 315   1         }
 316          /*----------------------------------------------------
 317             ElecMotor_Delay_ACW()
 318             Delay program for Electric Motor.
 319          -----------------------------------------------------*/
 320          void ElecMotor_Delay_ACW(void)
 321             {
 322   1         tWord zz;
 323   1      
 324   1      // Delay_500ms();
 325   1      // Delay_500ms();
 326   1      // Delay_500ms();
 327   1         
 328   1         Delay_100ms(); Delay_100ms();Delay_100ms();Delay_100ms();
 329   1         
 330   1         
 331   1         for(zz = 0; zz < 35; zz++)
 332   1            {
 333   2            if(ElecMotor_overcurrent == 1)
 334   2               ElecMotor_OC_flag = 1;
 335   2            
 336   2            if(ElecMotor_OC_flag == 0)
 337   2               Delay_10ms();
 338   2            }
 339   1         
 340   1         if(ElecMotor_OC_flag == 0)
 341   1            {
 342   2            Delay_500ms();
 343   2            #ifdef Old_lock
                    Delay_500ms();
                    Delay_500ms();Delay_500ms();Delay_500ms();Delay_500ms();
                    //Delay_500ms();Delay_500ms();Delay_500ms();
                    #endif
 348   2            }
 349   1      
 350   1      /* for(zz = 0; zz < 300; zz++)
 351   1            {
 352   1            if(ElecMotor_overcurrent == 1)
 353   1               ElecMotor_OC_flag = 1;
 354   1            
 355   1            if(ElecMotor_OC_flag == 0)
 356   1               Delay_10ms();
 357   1            }
 358   1      */
 359   1      // #ifdef Guxingzha
 360   1      // Delay_500ms();
 361   1      // Delay_500ms();
 362   1      // #endif
 363   1         
 364   1         #ifdef Z3
C51 COMPILER V9.54   ELECMOTOR                                                             04/29/2017 16:17:09 PAGE 7   

                 Delay_500ms();
                 #endif
 367   1      
 368   1         if(ElecMotor_OC_flag == 1)
 369   1            OC_count += 1;
 370   1      
 371   1      /* if(ElecMotor_overcurrent == 0)
 372   1            {
 373   1            Delay_500ms();
 374   1            Delay_500ms();
 375   1            Delay_500ms();
 376   1            Delay_500ms();
 377   1            Delay_500ms();
 378   1            Delay_500ms();
 379   1            }
 380   1      */
 381   1         }
 382          
 383          /*---------------------------------------------------
 384             end of file
 385          ----------------------------------------------------*/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    581    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =      2      12
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
