C51 COMPILER V9.54   OPERATION                                                             06/14/2017 16:44:53 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE OPERATION
OBJECT MODULE PLACED IN .\operation.obj
COMPILER INVOKED BY: D:\Program Files\Keil_v5\C51\BIN\C51.EXE ..\Library\operation.c COMPACT ROM(COMPACT) OPTIMIZE(8,SPE
                    -ED) BROWSE INCDIR(..\Library) DEBUG OBJECTEXTEND PRINT(.\operation.lst) TABS(2) OBJECT(.\operation.obj)

line level    source

   1          /*-------------------------------------------------------------
   2            operation.c
   3            ¸÷Àà²Ù×÷³ÌÐò
   4          --------------------------------------------------------------*/
   5          
   6          #include "main.h"
   7          #include "port.h"
   8          
   9          #include "operation.h"
  10          #include "other.h"
  11          #include "voice.h"
  12          #include "battery.h"
  13          #include "delay.h"
  14          #include "ElecMotor.h"
  15          #include "communication.h"
  16          #include "schedular.h"
  17          #include "ISP_DataFlash.h"
  18          
  19          /*------ private variable --------------------------*/
  20          bit enable_sensor_delayEN = 0;    // ÑÓ³ÙÊ¹ÄÜ´«¸ÐÆ÷µÄÊ¹ÄÜ£¬²»ÄÜ¼´Ê±Ê¹ÄÜ´«¸ÐÆ÷£¬ÐèÒª¹ýÒ»¶ÎÊ±¼ä   
  21          
  22          bit sensor_EN = 0;
  23          
  24          tWord key_rotate_off_time = 0;
  25          tWord wire_broken_time = 0;
  26          tByte wire_broken_level = 0;
  27          
  28          bit vibration_flag1 = 0;
  29          tWord vibration_count1 = 0;
  30          tWord ADC_check_saved_result = 0;   //×÷ÎªAD¼ì²âÖµµÄ´æ´¢Öµ£¬¼´ÉÏÒ»´Î²¥±¨µÄÖµ¡£
  31          
  32          
  33          tByte vibration_count2 = 0;
  34          /*------- Public variable declarations --------------------------*/
  35          extern bit position_sensor_EN;    
  36          extern bit fell_flag;           
  37          extern bit raised_flag;       
  38          extern tByte sensor_trigger_count;  
  39          extern tByte sensor_1ststage_count; 
  40          extern bit raised_fell_once_flag;     
  41          extern bit raised_fell_flag;          
  42          extern bit EN_host_stolen_alarming;     
  43          extern bit host_stolen_alarm2_EN;      
  44          extern tByte host_stolen_alarm1_count;    
  45          extern tByte host_stolen_alarm2_count;    
  46          extern bit Host_stolen_alarming;          
  47          extern tWord sensor_3rdstage_time;      
  48          extern tByte sensor_3rdstage_effcount;    
  49          extern tByte sensor_3rdstage_count;     
  50          extern tWord sensor_3rdstage_interval;    
  51          extern tWord sensor_2ndstage_time;    
  52          extern tByte sensor_2ndstage_count;   
  53          extern tWord ADC_check_result;    
  54          extern tByte wire_broken_count;   
C51 COMPILER V9.54   OPERATION                                                             06/14/2017 16:44:53 PAGE 2   

  55          extern bit wire_broken_flag;      
  56          extern bit battery_stolen_EN;     
  57          extern tByte battery_stolen_count;
  58          extern bit sensor_3rdalarm_flag;
  59          extern tByte enable_sensor_delay_count;   
  60          extern bit Silence_Flag;
  61          extern tByte Open_action_flag;    
  62          extern tByte ID_certificated_numbers;
  63          extern bit ID_certificated_flag;      
  64          extern tByte After_IDcert_timecount;    
  65          extern bit never_alarm;
  66          extern bit IDkey_selflearn_flag1;
  67          extern bit IDkey_selflearn_flag2;
  68          extern bit IDkey_selflearn_flag3;
  69          extern bit IDkey_selflearn_flag4;
  70          extern bit IDkey_selflearn_flag5;
  71          extern bit ID_selflearning_flag;
  72          extern tByte ID_selflearning_timecount;
  73          extern tWord IDkey_selflearn_HVcount;
  74          extern tWord IDkey_selflearn_LVcount;
  75          extern tByte fell_alarm_count;
  76          extern tByte raised_alarm_count;
  77          extern tByte Check_Motobattery_count;
  78          extern bit Check_Motobattery_flag;
  79          extern tWord load_battery_result;
  80          extern bit ID_speeched_flag;
  81          extern bit slave_nearby_actioned_flag;
  82          extern bit IDkey_speech_flash;
  83          extern bit wire_broken_reset;
  84          extern tByte Stolen_alarm_reset_count;
  85          extern bit vibration_flag;
  86          extern tByte slave_nearby_count;
  87          extern bit wheeled_flag;
  88          extern bit IDkey_flash_EN;
  89          extern bit flashing_flag;
  90          extern tWord vibration_count;
  91          extern tWord wheeled_count;
  92          extern bit Just_power_up;
  93          extern bit Autolock_G;
  94          extern tWord timer0_count2;
  95          extern bit Emergency_open_G;
  96          extern bit Battery_flag;
  97          
  98          /*-----------------------------------------
  99            slave_away_operation()
 100            
 101            operation for slave is away
 102          ------------------------------------------*/
 103          void slave_away_operation(void)
 104            { 
 105   1        
 106   1        if(Autolock_G == 1)
 107   1        {
 108   2          close_lock_dingdong_speech();
 109   2        }
 110   1        else
 111   1        {
 112   2          ID_speech();
 113   2          ID_speech();
 114   2        }
 115   1      
 116   1          if(Silence_Flag == 0)
C51 COMPILER V9.54   OPERATION                                                             06/14/2017 16:44:53 PAGE 3   

 117   1          {
 118   2          #ifdef voice
                  close_lock_speech();
                  #endif
 121   2            
 122   2      
 123   2          #ifdef BroadcastBattery
                  Broadcast_battery();
                  #endif
 126   2          
 127   2      //    Check_Motobattery_flag = 1;
 128   2      //    Check_Motobattery_count = 0;
 129   2           }
 130   1        // Enable_sensor(); 
 131   1        enable_sensor_delayEN = 1;
 132   1        enable_sensor_delay_count = 0;
 133   1        // delay time, avoid sensor trigger on.
 134   1        Delay(20);
 135   1        ID_certificated_numbers = 0;
 136   1      
 137   1        if(Silence_Flag == 1)
 138   1          Silence_Flag = 0;
 139   1        }
 140          
 141          /*----------------------------------------------------------------------
 142              slave_nearby_operation()
 143              operation for slave is nearby
 144          ----------------------------------------------------------------------*/
 145          void slave_nearby_operation(void)
 146            {
 147   1        slave_nearby_actioned_flag = 1;
 148   1        
 149   1        ID_speeched_flag = 0;   
 150   1        After_IDcert_timecount = 0;
 151   1        ID_certificated_flag = 0;
 152   1        ID_certificated_numbers = 0;    
 153   1      
 154   1        Delay_500ms();
 155   1        Delay_500ms();
 156   1        Delay_500ms();
 157   1        Delay_500ms();
 158   1      //  Externalmotor = 0;
 159   1        
 160   1        if(Emergency_open_G == 0)
 161   1          {
 162   2          Generator_lock = 1;
 163   2          }
 164   1        
 165   1          
 166   1        ID_speech();
 167   1      
 168   1        
 169   1        if(Silence_Flag == 0)
 170   1          {
 171   2          #ifdef voice
                    key_rotate_on_speech();
                    open_lock_speech();
                  #endif
 175   2      //    Externalmotor = 0;
 176   2          
 177   2          if(Just_power_up == 0)
 178   2            {
C51 COMPILER V9.54   OPERATION                                                             06/14/2017 16:44:53 PAGE 4   

 179   3            #ifdef BroadcastBattery
                    Broadcast_battery();
                    #endif
 182   3            }
 183   2          }
 184   1      
 185   1      /*
 186   1        if(Silence_Flag == 0)
 187   1          {
 188   1          open_lock_speech();
 189   1      //    Externalmotor = 0;
 190   1          if(Just_power_up == 0)
 191   1            verifybattery(load_battery_result);
 192   1          key_rotate_on_speech();
 193   1          }
 194   1        else
 195   1          {
 196   1          Delay_500ms();
 197   1          Delay_500ms();
 198   1      //    Externalmotor = 0;
 199   1          }
 200   1      */    
 201   1      
 202   1        }
 203          
 204          /*------------------------------------------------------------------
 205            InitSensor()
 206            Initialise Sensor.
 207          ------------------------------------------------------------------*/
 208          void InitSensor(void)
 209            {
 210   1        sensor_EN = 0;
 211   1        position_sensor_EN = 0;
 212   1        enable_sensor_delayEN = 0;  
 213   1        raised_sensor_detect = 1;
 214   1        fell_sensor_detect = 1; 
 215   1        }
 216            
 217          /*------------------------------------------------------------------
 218            Host_stolen_action()
 219            Determine host has been triggled 3 times, alarm action.
 220          ------------------------------------------------------------------*/
 221          void Host_stolen_action(void)
 222            {
 223   1        // if host has been touched 3 times, alarm 2 speeches alternantively.
 224   1        if(EN_host_stolen_alarming == 1)
 225   1          {
 226   2          Host_stolen_alarming = 1;
 227   2          
 228   2          stolen_alarm_speech1();
 229   2          stolen_alarm_speech2();
 230   2          #ifdef voice
                  #endif
 232   2            
 233   2          #ifdef Z3
                  if(wire_broken_flag == 0)
                    {
                    UART_Send_Data(ComMode_3);                                      
                    }
                  else
                    {                                                                     
                    UART_Send_Data(ComMode_6);                                      
C51 COMPILER V9.54   OPERATION                                                             06/14/2017 16:44:53 PAGE 5   

                    }
                  #endif
 243   2          }
 244   1        }
 245          
 246          /*------------------------------------------------------------------
 247            ENsensor_afterIDcert()
 248            6s After ID certificated, enable sensor. 
 249            If ID certficated 6 times, don't enable sensor.
 250          ------------------------------------------------------------------*/
 251          void ENsensor_afterIDcert(void)
 252            {
 253   1        if(ID_certificated_flag == 1)
 254   1          {
 255   2          // 3 tickets after ID certificated.
 256   2          if(++After_IDcert_timecount >= 15)
 257   2            {
 258   3            ID_certificated_flag = 0;
 259   3            After_IDcert_timecount = 0;     
 260   3            ID_certificated_numbers = 0;
 261   3            
 262   3            // 
 263   3            if((Open_action_flag == 0)&&(never_alarm == 0))
 264   3              {
 265   4              Enable_sensor();          
 266   4              }       
 267   3            never_alarm = 0;
 268   3            
 269   3            }     
 270   2          }
 271   1        }
 272          
 273          /*------------------------------------------------------------------
 274            ENsensor_After_Close()
 275          ------------------------------------------------------------------*/
 276          void ENsensor_After_Close(void)
 277            {
 278   1        if((enable_sensor_delayEN == 1)&&((key_rotate == 0)||(Autolock_G == 1)))
 279   1          {
 280   2          if(++enable_sensor_delay_count >= 3)
 281   2            {
 282   3            enable_sensor_delay_count = 0;
 283   3            enable_sensor_delayEN = 0;
 284   3            if(never_alarm == 0)
 285   3              Enable_sensor();
 286   3            }
 287   2          } 
 288   1        }
 289          
 290          /*-----------------------------------------------------------------
 291            SelfLearn_Reset()
 292            PIN22 triggles 3 times, the system enters selflearn mode
 293          ------------------------------------------------------------------*/
 294          void SelfLearn_Reset(void)
 295            { 
 296   1        if(ID_selflearning_flag == 1)
 297   1          {
 298   2          if(++ID_selflearning_timecount > 10)
 299   2            {
 300   3            ID_selflearning_flag = 0;
 301   3            ID_selflearning_timecount = 0;        
 302   3            // Reset relatively flag and count.
C51 COMPILER V9.54   OPERATION                                                             06/14/2017 16:44:53 PAGE 6   

 303   3            IDkey_selflearn_HVcount = 0;
 304   3            IDkey_selflearn_LVcount = 0;
 305   3            IDkey_selflearn_flag1 = 0;
 306   3            IDkey_selflearn_flag2 = 0;
 307   3            IDkey_selflearn_flag3 = 0;
 308   3            IDkey_selflearn_flag4 = 0;
 309   3            IDkey_selflearn_flag5 = 0;
 310   3            }     
 311   2          }
 312   1        }
 313          
 314          /*---------------------------------------------------
 315            Fell_Alarm_to_Slave()
 316            Send fell alarm signal to remote slave.
 317          ----------------------------------------------------*/
 318          void Fell_Alarm_to_Slave(void)
 319            {
 320   1        if((fell_flag==1)&&(fell_alarm_count<5))
 321   1          {
 322   2          UART_Send_Data(ComMode_5);                                      
 323   2          fell_alarm_count++;
 324   2          } 
 325   1        }
 326          
 327          /*----------------------------------------------------
 328            Raise_Alarm_to_Slave()
 329            Send raised alarm signal to remote slave
 330          -----------------------------------------------------*/
 331          void Raise_Alarm_to_Slave(void)
 332            {
 333   1        if((raised_flag==1)&&(raised_alarm_count<5))    
 334   1          {
 335   2          UART_Send_Data(ComMode_4);                                      
 336   2          raised_alarm_count++;
 337   2          }     
 338   1        }
 339          
 340          /*----------------------------------------------------
 341            Batstolen_Alarm_to_Slave()
 342            Send battery stolen alarm signal to remote slave
 343          -----------------------------------------------------*/
 344          void Batstolen_Alarm_to_Slave(void)
 345            {
 346   1        if((battery_stolen_EN == 1)&&(battery_stolen_count < 20))
 347   1          {
 348   2          UART_Send_Data(ComMode_2);                                      
 349   2          battery_stolen_count++;
 350   2          } 
 351   1        }
 352          
 353          /*----------------------------------------------------
 354            Disable_sensor_after_IDcert()
 355          -----------------------------------------------------*/
 356          void Disable_sensor_after_IDcert(void)
 357            {
 358   1        if(IDkey_speech_flash == 1)
 359   1          {
 360   2          IDkey_speech_flash = 0;
 361   2      
 362   2          disable_sensor();
 363   2          } 
 364   1        }
C51 COMPILER V9.54   OPERATION                                                             06/14/2017 16:44:53 PAGE 7   

 365          
 366          /*----------------------------------------------------
 367            Reset_after_wirebroken()
 368          -----------------------------------------------------*/
 369          void Reset_after_wirebroken(void)
 370            {
 371   1        if(wire_broken_reset == 1)
 372   1          {
 373   2          wire_broken_reset = 0;
 374   2          host_stolen_alarm1_count = 0;
 375   2          EN_host_stolen_alarming = 0;        
 376   2          Host_stolen_alarming = 0;
 377   2          sensor_3rdalarm_flag = 0;
 378   2          }
 379   1        }
 380          
 381          /*----------------------------------------------------
 382            Reset_after_stolen_alarming()
 383            15 tickets after stolen alarm, shut alarm.
 384          -----------------------------------------------------*/
 385          void Reset_after_stolen_alarming(void)
 386            {
 387   1        if(EN_host_stolen_alarming == 1)
 388   1          {
 389   2          if(++Stolen_alarm_reset_count > 3)
 390   2            {
 391   3            host_stolen_alarm1_count = 0;
 392   3            EN_host_stolen_alarming = 0;
 393   3            Host_stolen_alarming = 0;
 394   3            sensor_3rdalarm_flag = 0;
 395   3            Stolen_alarm_reset_count = 0;
 396   3            close_tranceiver();
 397   3            
 398   3            // ç”µæœºé”æ­»å…³é—­ï¼Œå¹¶ä¸”æŽ§åˆ¶å™¨ç”µæºæ‰“å¼€
 399   3            Generator_lock = 0;
 400   3            Externalmotor = 1;
 401   3            }
 402   2          }
 403   1        }
 404          
 405          /*-----------------------------------------------------
 406            Ensensor_after_slave_away()
 407          ------------------------------------------------------*/
 408          void Ensensor_after_slave_away(void)
 409            {
 410   1        if((vibration_flag1 == 0)&&(wheeled_flag == 0)&&(Just_power_up == 0))
 411   1          {
 412   2          if(++slave_nearby_count > 6)
 413   2            {
 414   3            slave_nearby_count = 7;
 415   3            slave_nearby_actioned_flag = 0;
 416   3            ID_certificated_flag = 0;
 417   3            if(never_alarm == 0)
 418   3              Enable_sensor();
 419   3            }
 420   2          } 
 421   1        }
 422          
 423          /*----------------------------------------------------
 424            Detect_selflearn_action()
 425          -----------------------------------------------------*/
 426          void Detect_selflearn_action(void)
C51 COMPILER V9.54   OPERATION                                                             06/14/2017 16:44:53 PAGE 8   

 427            {
 428   1        if((key_rotate == 1)||(Emergency_open_G == 1))
 429   1      //  if(key_rotate == 1)
 430   1          {
 431   2          // Èç¹ûÔ¿³×´ò¿ª£¬Ôò´ò¿ª¿ØÖÆÆ÷12VµçÔ´¡£
 432   2          Lock_EN = 0;
 433   2      
 434   2          if(wire_broken == 1)
 435   2            {
 436   3            wire_broken_time += 1;
 437   3            if(wire_broken_time >= 6000)
 438   3              {
 439   4              wire_broken_time = 6001;
 440   4              wire_broken_level = 0;
 441   4              ID_selflearning_flag = 0;
 442   4              }
 443   3            }
 444   2          else
 445   2            {
 446   3            if(wire_broken_time > 50)
 447   3              {
 448   4              wire_broken_time = 0;
 449   4              wire_broken_level += 1;
 450   4              }
 451   3            }
 452   2          
 453   2          if(wire_broken_level > 6)
 454   2            {
 455   3            wire_broken_level = 0;
 456   3            ID_selflearning_flag = 1;
 457   3            Self_learn_speech();
 458   3            }
 459   2          }
 460   1        else if((key_rotate == 0)&&(Open_action_flag == 0)&&(Emergency_open_G == 0))
 461   1      //  else if((key_rotate == 0)&&(Open_action_flag == 0))
 462   1          Lock_EN = 1;
 463   1      
 464   1          
 465   1        if(IDkey_flash_EN == 1)
 466   1          {
 467   2          IDkey_flash_EN = 0;
 468   2          flashing_flag = 1;
 469   2          ID_selflearning_flag = 0;
 470   2          
 471   2          Self_learn_programming();
 472   2          Self_learn_speech();
 473   2          
 474   2          #if (defined Z3) && (defined ID)
                    UART_Send_Data_match();
                  #endif
 477   2          }
 478   1        }
 479          
 480          /*---------------------------------------------------
 481            Detect_open_action()
 482          ---------------------------------------------------*/
 483          void Detect_open_action(void)
 484            {
 485   1        if(((key_rotate == 1)||(Emergency_open_G == 1))&&(Open_action_flag == 0)&&(ID_certificated_flag == 1)&&(n
             -ever_alarm == 0))   
 486   1          {
 487   2          disable_sensor();
C51 COMPILER V9.54   OPERATION                                                             06/14/2017 16:44:53 PAGE 9   

 488   2          Open_action_flag = 1;
 489   2          ID_speeched_flag = 0;
 490   2          
 491   2          After_IDcert_timecount = 0;
 492   2          ID_certificated_flag = 0;
 493   2          ID_certificated_numbers = 0;
 494   2          slave_nearby_actioned_flag = 1;
 495   2          ElecMotor_CW();
 496   2          slave_nearby_operation();
 497   2          
 498   2          if(Just_power_up == 1)    //åˆ¤æ–­
 499   2          {
 500   3            if(ADC_check_result < 0x230)
 501   3            {
 502   4              Battery_flag = 0;   //è¡¨ç¤ºç”µç“¶ä¸º48Vç”µç“¶
 503   4            }
 504   3            else
 505   3            {
 506   4              Battery_flag = 1;   //è¡¨ç¤ºç”µç“¶ä¸º60Vç”µç“¶
 507   4            }   
 508   3          }
 509   2          Just_power_up = 0;
 510   2              
 511   2          Autolock_G = 0;
 512   2          timer0_count2 = 0;
 513   2          }       
 514   1        }
 515          
 516          /*---------------------------------------------------
 517            Detect_close_action()
 518          ---------------------------------------------------*/
 519          void Detect_close_action(void)
 520            {
 521   1        if((((key_rotate == 0)&&(Emergency_open_G == 0))||(slave_nearby_actioned_flag == 0)||(Autolock_G == 1))&&
             -(Open_action_flag == 1))
 522   1      //  if(((key_rotate == 0)||(slave_nearby_actioned_flag == 0)||(Autolock_G == 1)||(Emergency_open_G == 0))&&
             -(Open_action_flag == 1))
 523   1          {
 524   2          
 525   2          if((vibration_flag == 0)&&(wheeled_flag == 0))
 526   2            {
 527   3            key_rotate_off_time += 1;
 528   3            if(key_rotate_off_time >= 500)
 529   3              {
 530   4              if((key_rotate == 0)||(slave_nearby_actioned_flag == 0)||(Autolock_G == 1))
 531   4                {
 532   5                Generator_lock = 0;
 533   5                ElecMotor_ACW();
 534   5      
 535   5                Open_action_flag = 0;
 536   5                slave_away_operation();
 537   5                IDkey_speech_flash = 0;
 538   5                ID_speeched_flag = 0;
 539   5      
 540   5                timer0_count2 = 0;
 541   5                Emergency_open_G = 0;
 542   5                }
 543   4              }
 544   3            }
 545   2          }
 546   1        else if(key_rotate == 1)
 547   1          {
C51 COMPILER V9.54   OPERATION                                                             06/14/2017 16:44:53 PAGE 10  

 548   2          key_rotate_off_time = 0;
 549   2          }
 550   1        }
 551          
 552          /*------------------------------------------------------
 553            Detect_vibration()
 554          -------------------------------------------------------*/
 555          void Detect_vibration(void)
 556            {
 557   1        if((sensor_detect == 0)||(horizontal_sensor == 0)||(the3rd_sendor == 0))
 558   1          {
 559   2          if(++vibration_count2 >= 1)
 560   2            {
 561   3            vibration_count2 = 0;
 562   3            vibration_flag = 1;
 563   3            vibration_count = 0;
 564   3            
 565   3            vibration_flag1 = 1;
 566   3            vibration_count1 = 0; 
 567   3            
 568   3            timer0_count2 = 0;      
 569   3            }   
 570   2          }
 571   1        else
 572   1          vibration_count2 = 0;
 573   1          
 574   1          if(vibration_flag == 1)
 575   1          {
 576   2          if(++vibration_count >= 2000)
 577   2            {
 578   3            vibration_flag = 0;
 579   3            vibration_count = 0;
 580   3            }
 581   2          }
 582   1      
 583   1          if(vibration_flag1 == 1)
 584   1          {
 585   2          if(++vibration_count1 >= 10000)
 586   2            {
 587   3            vibration_flag1 = 0;
 588   3            vibration_count1 = 0;
 589   3            }
 590   2          }
 591   1        }
 592          
 593          /*----------------------------------------------------
 594            Detect_wheel_moving()
 595          -----------------------------------------------------*/
 596          void Detect_wheel_moving(void)
 597            {
 598   1        if(wheeled_rotate == 1)
 599   1          {
 600   2          wheeled_flag = 1;
 601   2          wheeled_count = 0;
 602   2          
 603   2          timer0_count2 = 0;
 604   2          }
 605   1        if(wheeled_flag == 1)
 606   1          {
 607   2          if(++wheeled_count >= 2000)
 608   2            {
 609   3            wheeled_flag = 0;
C51 COMPILER V9.54   OPERATION                                                             06/14/2017 16:44:53 PAGE 11  

 610   3            wheeled_count = 0;
 611   3               }
 612   2          } 
 613   1        }
 614          
 615          /*---------------------------------------------------
 616            end of file
 617          ----------------------------------------------------*/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    794    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =     10    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
