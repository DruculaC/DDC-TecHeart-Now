C51 COMPILER V9.54   OPERATION                                                             07/07/2017 14:05:19 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE OPERATION
OBJECT MODULE PLACED IN .\operation.obj
COMPILER INVOKED BY: D:\Program Files\Keil_v5\C51\BIN\C51.EXE ..\Library\operation.c COMPACT ROM(COMPACT) OPTIMIZE(8,SPE
                    -ED) BROWSE INCDIR(..\Library) DEBUG OBJECTEXTEND PRINT(.\operation.lst) TABS(2) OBJECT(.\operation.obj)

line level    source

   1          /*-------------------------------------------------------------
   2            operation.c
   3            ¸÷Àà²Ù×÷³ÌÐò
   4          --------------------------------------------------------------*/
   5          
   6          #include "main.h"
   7          #include "port.h"
   8          
   9          #include "operation.h"
  10          #include "other.h"
  11          #include "voice.h"
  12          #include "battery.h"
  13          #include "delay.h"
  14          #include "ElecMotor.h"
  15          #include "communication.h"
  16          #include "schedular.h"
  17          #include "ISP_DataFlash.h"
  18          
  19          /*------ private variable --------------------------*/
  20          bit enable_sensor_delayEN = 0;    // ÑÓ³ÙÊ¹ÄÜ´«¸ÐÆ÷µÄÊ¹ÄÜ£¬²»ÄÜ¼´Ê±Ê¹ÄÜ´«¸ÐÆ÷£¬ÐèÒª¹ýÒ»¶ÎÊ±¼ä   
  21          
  22          bit sensor_EN = 0;
  23          
  24          tWord key_rotate_off_time = 0;
  25          tWord wire_broken_time = 0;
  26          tByte wire_broken_level = 0;
  27          
  28          bit vibration_flag1 = 0;
  29          tWord vibration_count1 = 0;
  30          tWord ADC_check_saved_result = 0;   //×÷ÎªAD¼ì²âÖµµÄ´æ´¢Öµ£¬¼´ÉÏÒ»´Î²¥±¨µÄÖµ¡£
  31          
  32          
  33          tByte vibration_count2 = 0;
  34          /*------- Public variable declarations --------------------------*/
  35          extern bit position_sensor_EN;    
  36          extern bit fell_flag;           
  37          extern bit raised_flag;       
  38          extern tByte sensor_trigger_count;  
  39          extern tByte sensor_1ststage_count; 
  40          extern bit raised_fell_once_flag;     
  41          extern bit raised_fell_flag;          
  42          extern bit EN_host_stolen_alarming;     
  43          extern bit host_stolen_alarm2_EN;      
  44          extern tByte host_stolen_alarm1_count;    
  45          extern tByte host_stolen_alarm2_count;    
  46          extern bit Host_stolen_alarming;          
  47          extern tWord sensor_3rdstage_time;      
  48          extern tByte sensor_3rdstage_effcount;    
  49          extern tByte sensor_3rdstage_count;     
  50          extern tWord sensor_3rdstage_interval;    
  51          extern tWord sensor_2ndstage_time;    
  52          extern tByte sensor_2ndstage_count;   
  53          extern tWord ADC_check_result;    
  54          extern tByte wire_broken_count;   
C51 COMPILER V9.54   OPERATION                                                             07/07/2017 14:05:19 PAGE 2   

  55          extern bit wire_broken_flag;      
  56          extern bit battery_stolen_EN;     
  57          extern tByte battery_stolen_count;
  58          extern bit sensor_3rdalarm_flag;
  59          extern tByte enable_sensor_delay_count;   
  60          extern bit Silence_Flag;
  61          extern tByte Open_action_flag;    
  62          extern tByte ID_certificated_numbers;
  63          extern bit ID_certificated_flag;      
  64          extern tByte After_IDcert_timecount;    
  65          extern bit never_alarm;
  66          extern bit IDkey_selflearn_flag1;
  67          extern bit IDkey_selflearn_flag2;
  68          extern bit IDkey_selflearn_flag3;
  69          extern bit IDkey_selflearn_flag4;
  70          extern bit IDkey_selflearn_flag5;
  71          extern bit ID_selflearning_flag;
  72          extern tByte ID_selflearning_timecount;
  73          extern tWord IDkey_selflearn_HVcount;
  74          extern tWord IDkey_selflearn_LVcount;
  75          extern tByte fell_alarm_count;
  76          extern tByte raised_alarm_count;
  77          extern tByte Check_Motobattery_count;
  78          extern bit Check_Motobattery_flag;
  79          extern tWord load_battery_result;
  80          extern bit ID_speeched_flag;
  81          extern bit slave_nearby_actioned_flag;
  82          extern bit IDkey_speech_flash;
  83          extern bit wire_broken_reset;
  84          extern tByte Stolen_alarm_reset_count;
  85          extern bit vibration_flag;
  86          extern tByte slave_nearby_count;
  87          extern bit wheeled_flag;
  88          extern bit IDkey_flash_EN;
  89          extern bit flashing_flag;
  90          extern tWord vibration_count;
  91          extern tWord wheeled_count;
  92          extern bit Just_power_up;
  93          extern bit Autolock_G;
  94          extern tWord timer0_count2;
  95          extern bit Emergency_open_G;
  96          extern bit Battery_flag;
  97          
  98          /*-----------------------------------------
  99            slave_away_operation()
 100            
 101            operation for slave is away
 102          ------------------------------------------*/
 103          void slave_away_operation(void)
 104            { 
 105   1        
 106   1        #ifdef novoice  
 107   1        if(Autolock_G == 1)
 108   1        {
 109   2          close_lock_dingdong_speech();
 110   2        }
 111   1        else
 112   1        {
 113   2          ID_speech();
 114   2          ID_speech();
 115   2        }
 116   1        #endif
C51 COMPILER V9.54   OPERATION                                                             07/07/2017 14:05:19 PAGE 3   

 117   1        
 118   1          if(Silence_Flag == 0)
 119   1          {
 120   2          #ifdef voice
 121   2          close_lock_speech();
 122   2          #endif
 123   2            
 124   2      
 125   2          #ifdef BroadcastBattery
 126   2          Broadcast_battery();
 127   2          #endif
 128   2          
 129   2      //    Check_Motobattery_flag = 1;
 130   2      //    Check_Motobattery_count = 0;
 131   2           }
 132   1        // Enable_sensor(); 
 133   1        enable_sensor_delayEN = 1;
 134   1        enable_sensor_delay_count = 0;
 135   1        // delay time, avoid sensor trigger on.
 136   1        Delay(20);
 137   1        ID_certificated_numbers = 0;
 138   1      
 139   1        if(Silence_Flag == 1)
 140   1          Silence_Flag = 0;
 141   1        }
 142          
 143          /*----------------------------------------------------------------------
 144              slave_nearby_operation()
 145              operation for slave is nearby
 146          ----------------------------------------------------------------------*/
 147          void slave_nearby_operation(void)
 148            {
 149   1        slave_nearby_actioned_flag = 1;
 150   1        
 151   1        ID_speeched_flag = 0;   
 152   1        After_IDcert_timecount = 0;
 153   1        ID_certificated_flag = 0;
 154   1        ID_certificated_numbers = 0;    
 155   1      
 156   1        Delay_500ms();
 157   1        Delay_500ms();
 158   1        Delay_500ms();
 159   1        Delay_500ms();
 160   1      //  Externalmotor = 0;
 161   1        
 162   1        if(Emergency_open_G == 0)
 163   1          {
 164   2          Generator_lock = 1;
 165   2          }
 166   1        
 167   1        #ifdef novoice  
 168   1        ID_speech();
 169   1        #endif
 170   1        
 171   1        if(Silence_Flag == 0)
 172   1          {
 173   2          #ifdef voice
 174   2            key_rotate_on_speech();
 175   2            open_lock_speech();
 176   2          #endif
 177   2      //    Externalmotor = 0;
 178   2          
C51 COMPILER V9.54   OPERATION                                                             07/07/2017 14:05:19 PAGE 4   

 179   2          if(Just_power_up == 0)
 180   2            {
 181   3            #ifdef BroadcastBattery
 182   3            Broadcast_battery();
 183   3            #endif
 184   3            }
 185   2          }
 186   1      
 187   1      /*
 188   1        if(Silence_Flag == 0)
 189   1          {
 190   1          open_lock_speech();
 191   1      //    Externalmotor = 0;
 192   1          if(Just_power_up == 0)
 193   1            verifybattery(load_battery_result);
 194   1          key_rotate_on_speech();
 195   1          }
 196   1        else
 197   1          {
 198   1          Delay_500ms();
 199   1          Delay_500ms();
 200   1      //    Externalmotor = 0;
 201   1          }
 202   1      */    
 203   1      
 204   1        }
 205          
 206          /*------------------------------------------------------------------
 207            InitSensor()
 208            Initialise Sensor.
 209          ------------------------------------------------------------------*/
 210          void InitSensor(void)
 211            {
 212   1        sensor_EN = 0;
 213   1        position_sensor_EN = 0;
 214   1        enable_sensor_delayEN = 0;  
 215   1        raised_sensor_detect = 1;
 216   1        fell_sensor_detect = 1; 
 217   1        }
 218            
 219          /*------------------------------------------------------------------
 220            Host_stolen_action()
 221            Determine host has been triggled 3 times, alarm action.
 222          ------------------------------------------------------------------*/
 223          void Host_stolen_action(void)
 224            {
 225   1        // if host has been touched 3 times, alarm 2 speeches alternantively.
 226   1        if(EN_host_stolen_alarming == 1)
 227   1          {
 228   2          Host_stolen_alarming = 1;
 229   2          
 230   2          stolen_alarm_speech1();
 231   2          stolen_alarm_speech2();
 232   2          #ifdef voice
 233   2          #endif
 234   2            
 235   2          #ifdef Z3
                  if(wire_broken_flag == 0)
                    {
                    UART_Send_Data(ComMode_3);                                      
                    }
                  else
C51 COMPILER V9.54   OPERATION                                                             07/07/2017 14:05:19 PAGE 5   

                    {                                                                     
                    UART_Send_Data(ComMode_6);                                      
                    }
                  #endif
 245   2          }
 246   1        }
 247          
 248          /*------------------------------------------------------------------
 249            ENsensor_afterIDcert()
 250            6s After ID certificated, enable sensor. 
 251            If ID certficated 6 times, don't enable sensor.
 252          ------------------------------------------------------------------*/
 253          void ENsensor_afterIDcert(void)
 254            {
 255   1        if(ID_certificated_flag == 1)
 256   1          {
 257   2          // 3 tickets after ID certificated.
 258   2          if(++After_IDcert_timecount >= 15)
 259   2            {
 260   3            ID_certificated_flag = 0;
 261   3            After_IDcert_timecount = 0;     
 262   3            ID_certificated_numbers = 0;
 263   3            
 264   3            // 
 265   3            if((Open_action_flag == 0)&&(never_alarm == 0))
 266   3              {
 267   4              Enable_sensor();          
 268   4              }       
 269   3            never_alarm = 0;
 270   3            
 271   3            }     
 272   2          }
 273   1        }
 274          
 275          /*------------------------------------------------------------------
 276            ENsensor_After_Close()
 277          ------------------------------------------------------------------*/
 278          void ENsensor_After_Close(void)
 279            {
 280   1        if((enable_sensor_delayEN == 1)&&((key_rotate == 0)||(Autolock_G == 1)))
 281   1          {
 282   2          if(++enable_sensor_delay_count >= 3)
 283   2            {
 284   3            enable_sensor_delay_count = 0;
 285   3            enable_sensor_delayEN = 0;
 286   3            if(never_alarm == 0)
 287   3              Enable_sensor();
 288   3            }
 289   2          } 
 290   1        }
 291          
 292          /*-----------------------------------------------------------------
 293            SelfLearn_Reset()
 294            PIN22 triggles 3 times, the system enters selflearn mode
 295          ------------------------------------------------------------------*/
 296          void SelfLearn_Reset(void)
 297            { 
 298   1        if(ID_selflearning_flag == 1)
 299   1          {
 300   2          if(++ID_selflearning_timecount > 10)
 301   2            {
 302   3            ID_selflearning_flag = 0;
C51 COMPILER V9.54   OPERATION                                                             07/07/2017 14:05:19 PAGE 6   

 303   3            ID_selflearning_timecount = 0;        
 304   3            // Reset relatively flag and count.
 305   3            IDkey_selflearn_HVcount = 0;
 306   3            IDkey_selflearn_LVcount = 0;
 307   3            IDkey_selflearn_flag1 = 0;
 308   3            IDkey_selflearn_flag2 = 0;
 309   3            IDkey_selflearn_flag3 = 0;
 310   3            IDkey_selflearn_flag4 = 0;
 311   3            IDkey_selflearn_flag5 = 0;
 312   3            }     
 313   2          }
 314   1        }
 315          
 316          /*---------------------------------------------------
 317            Fell_Alarm_to_Slave()
 318            Send fell alarm signal to remote slave.
 319          ----------------------------------------------------*/
 320          void Fell_Alarm_to_Slave(void)
 321            {
 322   1        if((fell_flag==1)&&(fell_alarm_count<5))
 323   1          {
 324   2          UART_Send_Data(ComMode_5);                                      
 325   2          fell_alarm_count++;
 326   2          } 
 327   1        }
 328          
 329          /*----------------------------------------------------
 330            Raise_Alarm_to_Slave()
 331            Send raised alarm signal to remote slave
 332          -----------------------------------------------------*/
 333          void Raise_Alarm_to_Slave(void)
 334            {
 335   1        if((raised_flag==1)&&(raised_alarm_count<5))    
 336   1          {
 337   2          UART_Send_Data(ComMode_4);                                      
 338   2          raised_alarm_count++;
 339   2          }     
 340   1        }
 341          
 342          /*----------------------------------------------------
 343            Batstolen_Alarm_to_Slave()
 344            Send battery stolen alarm signal to remote slave
 345          -----------------------------------------------------*/
 346          void Batstolen_Alarm_to_Slave(void)
 347            {
 348   1        if((battery_stolen_EN == 1)&&(battery_stolen_count < 20))
 349   1          {
 350   2          UART_Send_Data(ComMode_2);                                      
 351   2          battery_stolen_count++;
 352   2          } 
 353   1        }
 354          
 355          /*----------------------------------------------------
 356            Disable_sensor_after_IDcert()
 357          -----------------------------------------------------*/
 358          void Disable_sensor_after_IDcert(void)
 359            {
 360   1        if(IDkey_speech_flash == 1)
 361   1          {
 362   2          IDkey_speech_flash = 0;
 363   2      
 364   2          disable_sensor();
C51 COMPILER V9.54   OPERATION                                                             07/07/2017 14:05:19 PAGE 7   

 365   2          } 
 366   1        }
 367          
 368          /*----------------------------------------------------
 369            Reset_after_wirebroken()
 370          -----------------------------------------------------*/
 371          void Reset_after_wirebroken(void)
 372            {
 373   1        if(wire_broken_reset == 1)
 374   1          {
 375   2          wire_broken_reset = 0;
 376   2          host_stolen_alarm1_count = 0;
 377   2          EN_host_stolen_alarming = 0;        
 378   2          Host_stolen_alarming = 0;
 379   2          sensor_3rdalarm_flag = 0;
 380   2          }
 381   1        }
 382          
 383          /*----------------------------------------------------
 384            Reset_after_stolen_alarming()
 385            15 tickets after stolen alarm, shut alarm.
 386          -----------------------------------------------------*/
 387          void Reset_after_stolen_alarming(void)
 388            {
 389   1        if(EN_host_stolen_alarming == 1)
 390   1          {
 391   2          if(++Stolen_alarm_reset_count > 3)
 392   2            {
 393   3            host_stolen_alarm1_count = 0;
 394   3            EN_host_stolen_alarming = 0;
 395   3            Host_stolen_alarming = 0;
 396   3            sensor_3rdalarm_flag = 0;
 397   3            Stolen_alarm_reset_count = 0;
 398   3            close_tranceiver();
 399   3            
 400   3            // ç”µæœºé”æ­»å…³é—­ï¼Œå¹¶ä¸”æŽ§åˆ¶å™¨ç”µæºæ‰“å¼€
 401   3            Generator_lock = 0;
 402   3            Externalmotor = 1;
 403   3            }
 404   2          }
 405   1        }
 406          
 407          /*-----------------------------------------------------
 408            Ensensor_after_slave_away()
 409          ------------------------------------------------------*/
 410          void Ensensor_after_slave_away(void)
 411            {
 412   1        if((vibration_flag1 == 0)&&(wheeled_flag == 0)&&(Just_power_up == 0))
 413   1          {
 414   2          if(++slave_nearby_count > 6)
 415   2            {
 416   3            slave_nearby_count = 7;
 417   3            slave_nearby_actioned_flag = 0;
 418   3            ID_certificated_flag = 0;
 419   3            if(never_alarm == 0)
 420   3              Enable_sensor();
 421   3            }
 422   2          } 
 423   1        }
 424          
 425          /*----------------------------------------------------
 426            Detect_selflearn_action()
C51 COMPILER V9.54   OPERATION                                                             07/07/2017 14:05:19 PAGE 8   

 427          -----------------------------------------------------*/
 428          void Detect_selflearn_action(void)
 429            {
 430   1        if((key_rotate == 1)||(Emergency_open_G == 1))
 431   1      //  if(key_rotate == 1)
 432   1          {
 433   2          // Èç¹ûÔ¿³×´ò¿ª£¬Ôò´ò¿ª¿ØÖÆÆ÷12VµçÔ´¡£
 434   2          Lock_EN = 0;
 435   2      
 436   2          if(wire_broken == 1)
 437   2            {
 438   3            wire_broken_time += 1;
 439   3            if(wire_broken_time >= 6000)
 440   3              {
 441   4              wire_broken_time = 6001;
 442   4              wire_broken_level = 0;
 443   4              ID_selflearning_flag = 0;
 444   4              }
 445   3            }
 446   2          else
 447   2            {
 448   3            if(wire_broken_time > 50)
 449   3              {
 450   4              wire_broken_time = 0;
 451   4              wire_broken_level += 1;
 452   4              }
 453   3            }
 454   2          
 455   2          if(wire_broken_level > 6)
 456   2            {
 457   3            wire_broken_level = 0;
 458   3            ID_selflearning_flag = 1;
 459   3            Self_learn_speech();
 460   3            }
 461   2          }
 462   1        else if((key_rotate == 0)&&(Open_action_flag == 0)&&(Emergency_open_G == 0))
 463   1      //  else if((key_rotate == 0)&&(Open_action_flag == 0))
 464   1          Lock_EN = 1;
 465   1      
 466   1          
 467   1        if(IDkey_flash_EN == 1)
 468   1          {
 469   2          IDkey_flash_EN = 0;
 470   2          flashing_flag = 1;
 471   2          ID_selflearning_flag = 0;
 472   2          
 473   2          Self_learn_programming();
 474   2          Self_learn_speech();
 475   2          
 476   2          #if (defined Z3) && (defined ID)
                    UART_Send_Data_match();
                  #endif
 479   2          }
 480   1        }
 481          
 482          /*---------------------------------------------------
 483            Detect_open_action()
 484          ---------------------------------------------------*/
 485          void Detect_open_action(void)
 486            {
 487   1        if(((key_rotate == 1)||(Emergency_open_G == 1))&&(Open_action_flag == 0)&&(ID_certificated_flag == 1)&&(n
             -ever_alarm == 0))   
C51 COMPILER V9.54   OPERATION                                                             07/07/2017 14:05:19 PAGE 9   

 488   1          {
 489   2          disable_sensor();
 490   2          Open_action_flag = 1;
 491   2          ID_speeched_flag = 0;
 492   2          
 493   2          After_IDcert_timecount = 0;
 494   2          ID_certificated_flag = 0;
 495   2          ID_certificated_numbers = 0;
 496   2          slave_nearby_actioned_flag = 1;
 497   2          ElecMotor_CW();
 498   2          slave_nearby_operation();
 499   2          
 500   2          if(Just_power_up == 1)    //åˆ¤æ–­
 501   2          {
 502   3            if(ADC_check_result < 0x238)
 503   3            {
 504   4              Battery_flag = 0;   //è¡¨ç¤ºç”µç“¶ä¸º48Vç”µç“¶
 505   4            }
 506   3            else
 507   3            {
 508   4              Battery_flag = 1;   //è¡¨ç¤ºç”µç“¶ä¸º60Vç”µç“¶
 509   4            }   
 510   3          }
 511   2          Just_power_up = 0;
 512   2              
 513   2          Autolock_G = 0;
 514   2          timer0_count2 = 0;
 515   2          }       
 516   1        }
 517          
 518          /*---------------------------------------------------
 519            Detect_close_action()
 520          ---------------------------------------------------*/
 521          void Detect_close_action(void)
 522            {
 523   1        if((((key_rotate == 0)&&(Emergency_open_G == 0))||(slave_nearby_actioned_flag == 0)||(Autolock_G == 1))&&
             -(Open_action_flag == 1))
 524   1      //  if(((key_rotate == 0)||(slave_nearby_actioned_flag == 0)||(Autolock_G == 1)||(Emergency_open_G == 0))&&
             -(Open_action_flag == 1))
 525   1          {
 526   2          
 527   2          if((vibration_flag == 0)&&(wheeled_flag == 0))
 528   2            {
 529   3            key_rotate_off_time += 1;
 530   3            if(key_rotate_off_time >= 500)
 531   3              {
 532   4              if((key_rotate == 0)||(slave_nearby_actioned_flag == 0)||(Autolock_G == 1))
 533   4                {
 534   5                Generator_lock = 0;
 535   5                ElecMotor_ACW();
 536   5      
 537   5                Open_action_flag = 0;
 538   5                slave_away_operation();
 539   5                IDkey_speech_flash = 0;
 540   5                ID_speeched_flag = 0;
 541   5      
 542   5                timer0_count2 = 0;
 543   5                Emergency_open_G = 0;
 544   5                }
 545   4              }
 546   3            }
 547   2          }
C51 COMPILER V9.54   OPERATION                                                             07/07/2017 14:05:19 PAGE 10  

 548   1        else if(key_rotate == 1)
 549   1          {
 550   2          key_rotate_off_time = 0;
 551   2          }
 552   1        }
 553          
 554          /*------------------------------------------------------
 555            Detect_vibration()
 556          -------------------------------------------------------*/
 557          void Detect_vibration(void)
 558            {
 559   1        if((sensor_detect == 0)||(horizontal_sensor == 0)||(the3rd_sendor == 0))
 560   1          {
 561   2          if(++vibration_count2 >= 1)
 562   2            {
 563   3            vibration_count2 = 0;
 564   3            vibration_flag = 1;
 565   3            vibration_count = 0;
 566   3            
 567   3            vibration_flag1 = 1;
 568   3            vibration_count1 = 0; 
 569   3            
 570   3            timer0_count2 = 0;      
 571   3            }   
 572   2          }
 573   1        else
 574   1          vibration_count2 = 0;
 575   1          
 576   1          if(vibration_flag == 1)
 577   1          {
 578   2          if(++vibration_count >= 2000)
 579   2            {
 580   3            vibration_flag = 0;
 581   3            vibration_count = 0;
 582   3            }
 583   2          }
 584   1      
 585   1          if(vibration_flag1 == 1)
 586   1          {
 587   2          if(++vibration_count1 >= 10000)
 588   2            {
 589   3            vibration_flag1 = 0;
 590   3            vibration_count1 = 0;
 591   3            }
 592   2          }
 593   1        }
 594          
 595          /*----------------------------------------------------
 596            Detect_wheel_moving()
 597          -----------------------------------------------------*/
 598          void Detect_wheel_moving(void)
 599            {
 600   1        if(wheeled_rotate == 1)
 601   1          {
 602   2          wheeled_flag = 1;
 603   2          wheeled_count = 0;
 604   2          
 605   2          timer0_count2 = 0;
 606   2          }
 607   1        if(wheeled_flag == 1)
 608   1          {
 609   2          if(++wheeled_count >= 2000)
C51 COMPILER V9.54   OPERATION                                                             07/07/2017 14:05:19 PAGE 11  

 610   2            {
 611   3            wheeled_flag = 0;
 612   3            wheeled_count = 0;
 613   3               }
 614   2          } 
 615   1        }
 616          
 617          /*---------------------------------------------------
 618            end of file
 619          ----------------------------------------------------*/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    818    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =     10    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
