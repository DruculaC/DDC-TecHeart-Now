C51 COMPILER V9.54   OPERATION                                                             05/27/2015 11:54:09 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE OPERATION
OBJECT MODULE PLACED IN .\operation.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE ..\Library\operation.c COMPACT OPTIMIZE(8,SPEED) BRO
                    -WSE INCDIR(..\Library) DEBUG OBJECTEXTEND PRINT(.\operation.lst) OBJECT(.\operation.obj)

line level    source

   1          /*-------------------------------------------------------------
   2                  operation.c
   3                  各类操作程序
   4          --------------------------------------------------------------*/
   5          
   6          #include "main.h"
   7          #include "port.h"
   8          
   9          #include "operation.h"
  10          #include "other.h"
  11          #include "voice.h"
  12          #include "battery.h"
  13          #include "delay.h"
  14          #include "ElecMotor.h"
  15          #include "communication.h"
  16          #include "schedular.h"
  17          
  18          /*------ private variable --------------------------*/
  19          bit enable_sensor_delayEN = 0;          // 延迟使能传感器的使能，不能即时使能传感器，需要过一段时间             
  20          
  21          bit sensor_EN = 0;
  22          
  23          /*------- Public variable declarations --------------------------*/
  24          extern bit position_sensor_EN;          
  25          extern bit fell_flag;                                           
  26          extern bit raised_flag;                         
  27          extern tByte sensor_trigger_count;      
  28          extern tByte sensor_1ststage_count;     
  29          extern bit raised_fell_once_flag;                       
  30          extern bit raised_fell_flag;                                    
  31          extern bit host_stolen_alarm1_EN;     
  32          extern bit host_stolen_alarm2_EN;      
  33          extern tByte host_stolen_alarm1_count;          
  34          extern tByte host_stolen_alarm2_count;          
  35          extern bit stolen_alarm_flag;                                   
  36          extern tWord sensor_3rdstage_time;                      
  37          extern tByte sensor_3rdstage_effcount;          
  38          extern tByte sensor_3rdstage_count;                     
  39          extern tWord sensor_3rdstage_interval;          
  40          extern tWord sensor_2ndstage_time;              
  41          extern tByte sensor_2ndstage_count;             
  42          extern tWord ADC_check_result;          
  43          extern tByte wire_broken_count;         
  44          extern bit wire_broken_flag;                    
  45          extern bit battery_stolen_EN;                   
  46          extern tByte battery_stolen_count;
  47          extern bit sensor_3rdalarm_flag;
  48          extern tByte enable_sensor_delay_count;         
  49          extern bit Silence_Flag;
  50          extern tByte key_rotated_on_flag;               
  51          extern tByte IDkey_certificated_times;
  52          extern bit IDkey_flag;                  
  53          extern tByte IDkey_count;               
  54          extern bit never_alarm;
C51 COMPILER V9.54   OPERATION                                                             05/27/2015 11:54:09 PAGE 2   

  55          extern bit IDkey_selflearn_flag1;
  56          extern bit IDkey_selflearn_flag2;
  57          extern bit IDkey_selflearn_flag3;
  58          extern bit IDkey_selflearn_flag4;
  59          extern bit IDkey_selflearn_flag5;
  60          extern bit IDkey_selflearn_flag6;
  61          extern tByte IDkey_selflearn_flag6count;
  62          extern tWord IDkey_selflearn_HVcount;
  63          extern tWord IDkey_selflearn_LVcount;
  64          extern tByte fell_alarm_count;
  65          extern tByte raised_alarm_count;
  66          extern tByte Check_Motobattery_count;
  67          extern bit Check_Motobattery_flag;
  68          extern tWord load_battery_result;
  69          extern bit ID_speeched_flag;
  70          extern bit slave_nearby_actioned_flag;
  71          
  72          
  73          /*-----------------------------------------
  74                  slave_away_operation()
  75                  
  76                  operation for slave is away
  77          ------------------------------------------*/
  78          void slave_away_operation(void)
  79                  {
  80   1              
  81   1              if(Silence_Flag == 0)
  82   1                      {
  83   2                      close_lock_speech();    
  84   2                      
  85   2                      #ifdef Batterycheck
                              Check_Motobattery_flag = 1;
                              Check_Motobattery_count = 0;
                              #endif
  89   2      
  90   2                 }
  91   1              // enable_sensor();     
  92   1              enable_sensor_delayEN = 1;
  93   1              enable_sensor_delay_count = 0;
  94   1              // delay time, avoid sensor trigger on.
  95   1              Delay(20);
  96   1              IDkey_certificated_times = 0;
  97   1      
  98   1              if(Silence_Flag == 1)
  99   1                      Silence_Flag = 0;
 100   1              }
 101          
 102          /*----------------------------------------------------------------------
 103                          slave_nearby_operation()
 104                          operation for slave is nearby
 105          ----------------------------------------------------------------------*/
 106          void slave_nearby_operation(void)
 107                  {
 108   1              slave_nearby_actioned_flag = 1;
 109   1              
 110   1              ID_speeched_flag = 0;           
 111   1              IDkey_count = 0;
 112   1              IDkey_flag = 0;
 113   1              IDkey_certificated_times = 0;           
 114   1      
 115   1              if(Silence_Flag == 0)
 116   1                      {
C51 COMPILER V9.54   OPERATION                                                             05/27/2015 11:54:09 PAGE 3   

 117   2                      open_lock_speech();
 118   2                      #ifdef Batterycheck
                              verifybattery(load_battery_result);
                              #endif
 121   2                      key_rotate_on_speech();
 122   2                      }
 123   1              }
 124          
 125          /*------------------------------------------------------------------
 126                  InitSensor()
 127                  Initialise Sensor.
 128          ------------------------------------------------------------------*/
 129          void InitSensor(void)
 130                  {
 131   1              sensor_EN = 0;
 132   1              position_sensor_EN = 0;
 133   1              enable_sensor_delayEN = 0;      
 134   1              raised_sensor_detect = 1;
 135   1              fell_sensor_detect = 1; 
 136   1              }
 137                  
 138          /*------------------------------------------------------------------
 139                  Host_stolen_action()
 140                  Determine host has been triggled 3 times, alarm action.
 141          ------------------------------------------------------------------*/
 142          void Host_stolen_action(void)
 143                  {
 144   1              // whether host has been touched 3 times, if yes, then alarm 2 speech alternantively.
 145   1              if((host_stolen_alarm1_EN == 1)&&(host_stolen_alarm1_count < 4))
 146   1                      {
 147   2                      stolen_alarm_flag = 1;
 148   2                      
 149   2                      #ifdef Z3
                              if(wire_broken_flag == 0)
                                      {
                                      UART_Send_Data(ComMode_3);                                                                                                                                                      
                                      }
                              else
                                      {                                                                     
                                      UART_Send_Data(ComMode_6);                                                                                                                                                      
                                      }
                              #endif
 159   2                      
 160   2                      stolen_alarm_speech1();
 161   2                      if(++host_stolen_alarm1_count >= 4)
 162   2                              {
 163   3                              host_stolen_alarm1_count = 0;
 164   3                              host_stolen_alarm1_EN = 0;
 165   3                              stolen_alarm_flag = 0;
 166   3                              sensor_3rdalarm_flag = 0;
 167   3                              }
 168   2                      }
 169   1              if((host_stolen_alarm2_EN == 1)&&(host_stolen_alarm2_count < 4))
 170   1                      {
 171   2                      stolen_alarm_flag = 1;
 172   2                      
 173   2                      #ifdef Z3
                              if(wire_broken_flag == 0)
                                      {
                                      UART_Send_Data(ComMode_3);                                                                                                                                                      
                                      }
                              else
C51 COMPILER V9.54   OPERATION                                                             05/27/2015 11:54:09 PAGE 4   

                                      {
                                      UART_Send_Data(ComMode_6);                                                                                                                                                      
                                      }
                              #endif
 183   2                      
 184   2                      stolen_alarm_speech2();
 185   2                      if(++host_stolen_alarm2_count >= 4)
 186   2                              {
 187   3                              host_stolen_alarm2_count = 0;
 188   3                              host_stolen_alarm2_EN = 0;
 189   3                              stolen_alarm_flag = 0;
 190   3                              sensor_3rdalarm_flag = 0;
 191   3                              }
 192   2                      }       
 193   1              }
 194          
 195          /*------------------------------------------------------------------
 196                  ENsensor_afterIDcert()
 197                  4s After ID certificated, enable sensor. 
 198                  If ID certficated 6 times, don't enable sensor.
 199          ------------------------------------------------------------------*/
 200          void ENsensor_afterIDcert(void)
 201                  {
 202   1              if(IDkey_flag == 1)
 203   1                      {
 204   2                      if(++IDkey_count >= 3)
 205   2                              {
 206   3                              IDkey_count = 0;
 207   3                              IDkey_flag = 0;
 208   3                              IDkey_certificated_times = 0;
 209   3                              if((key_rotated_on_flag == 0)&&(never_alarm == 0))
 210   3                                      {
 211   4                                      enable_sensor();                                        
 212   4                                      }                               
 213   3                              never_alarm = 0;
 214   3                              }                       
 215   2                      }
 216   1              }
 217          
 218          /*------------------------------------------------------------------
 219                  ENsensor_After_CloseLock()
 220          ------------------------------------------------------------------*/
 221          void ENsensor_After_CloseLock(void)
 222                  {
 223   1              if((enable_sensor_delayEN == 1)&&(key_rotate == 0))
 224   1                      {
 225   2                      if(++enable_sensor_delay_count >= 3)
 226   2                              {
 227   3                              enable_sensor_delay_count = 0;
 228   3                              enable_sensor_delayEN = 0;
 229   3                              enable_sensor();
 230   3                              }
 231   2                      }       
 232   1              }
 233          
 234          /*-----------------------------------------------------------------
 235                  SelfLearn_Reset()
 236                  PIN26 triggles 3 times, the system enters selflearn mode
 237          ------------------------------------------------------------------*/
 238          void SelfLearn_Reset(void)
 239                  {
 240   1              if(IDkey_selflearn_flag6 == 1)
C51 COMPILER V9.54   OPERATION                                                             05/27/2015 11:54:09 PAGE 5   

 241   1                      {
 242   2                      if(++IDkey_selflearn_flag6count > 5)
 243   2                              {
 244   3                              IDkey_selflearn_HVcount = 0;
 245   3                              IDkey_selflearn_LVcount = 0;
 246   3                              IDkey_selflearn_flag1 = 0;
 247   3                              IDkey_selflearn_flag2 = 0;
 248   3                              IDkey_selflearn_flag3 = 0;
 249   3                              IDkey_selflearn_flag4 = 0;
 250   3                              IDkey_selflearn_flag5 = 0;
 251   3                              IDkey_selflearn_flag6 = 0;
 252   3                              IDkey_selflearn_flag6count = 0;                         
 253   3                              }                       
 254   2                      }
 255   1              }
 256          
 257          /*---------------------------------------------------
 258                  Fell_Alarm_to_Slave()
 259                  Send fell alarm signal to remote slave.
 260          ----------------------------------------------------*/
 261          void Fell_Alarm_to_Slave(void)
 262                  {
 263   1              if((fell_flag==1)&&(fell_alarm_count<5))
 264   1                      {
 265   2                      UART_Send_Data(ComMode_5);                                                                                                                                                      
 266   2                      fell_alarm_count++;
 267   2                      }       
 268   1              }
 269          
 270          /*----------------------------------------------------
 271                  Raise_Alarm_to_Slave()
 272                  Send raised alarm signal to remote slave
 273          -----------------------------------------------------*/
 274          void Raise_Alarm_to_Slave(void)
 275                  {
 276   1              if((raised_flag==1)&&(raised_alarm_count<5))            
 277   1                      {
 278   2                      UART_Send_Data(ComMode_4);                                                                                                                                                      
 279   2                      raised_alarm_count++;
 280   2                      }                       
 281   1              }
 282          
 283          /*----------------------------------------------------
 284                  Batstolen_Alarm_to_Slave()
 285                  Send battery stolen alarm signal to remote slave
 286          -----------------------------------------------------*/
 287          void Batstolen_Alarm_to_Slave(void)
 288                  {
 289   1              if((battery_stolen_EN == 1)&&(battery_stolen_count < 5))
 290   1                      {
 291   2                      UART_Send_Data(ComMode_2);                                                                                                                                                      
 292   2                      battery_stolen_count++;
 293   2                      }       
 294   1              }
 295          
 296          /*-----------------------------------------------------
 297                  Never_Alarm_Action()
 298                  ID cert
 299          /*---------------------------------------------------
 300                  end of file
 301          ----------------------------------------------------*/

C51 COMPILER V9.54   OPERATION                                                             05/27/2015 11:54:09 PAGE 6   


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    294    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
