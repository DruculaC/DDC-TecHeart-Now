C51 COMPILER V9.54   OPERATION                                                             06/04/2017 11:50:54 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE OPERATION
OBJECT MODULE PLACED IN .\operation.obj
COMPILER INVOKED BY: D:\Program Files\Keil_v5\C51\BIN\C51.EXE ..\Library\operation.c COMPACT ROM(COMPACT) OPTIMIZE(8,SPE
                    -ED) BROWSE INCDIR(..\Library) DEBUG OBJECTEXTEND PRINT(.\operation.lst) TABS(2) OBJECT(.\operation.obj)

line level    source

   1          /*-------------------------------------------------------------
   2            operation.c
   3            各类操作程序
   4          --------------------------------------------------------------*/
   5          
   6          #include "main.h"
   7          #include "port.h"
   8          
   9          #include "operation.h"
  10          #include "other.h"
  11          #include "voice.h"
  12          #include "battery.h"
  13          #include "delay.h"
  14          #include "ElecMotor.h"
*** ERROR C141 IN LINE 19 OF ..\Library\ElecMotor.h: syntax error near '<<'
*** ERROR C129 IN LINE 20 OF ..\Library\ElecMotor.h: missing ';' before '=='
  15          #include "communication.h"
  16          #include "schedular.h"
  17          #include "ISP_DataFlash.h"
  18          
  19          /*------ private variable --------------------------*/
  20          bit enable_sensor_delayEN = 0;    // 延迟使能传感器的使能，不能即时使能传感器，需要过一段时间   
  21          
  22          bit sensor_EN = 0;
  23          
  24          tWord key_rotate_off_time = 0;
  25          tWord wire_broken_time = 0;
  26          tByte wire_broken_level = 0;
  27          
  28          bit vibration_flag1 = 0;
  29          tWord vibration_count1 = 0;
  30          tWord ADC_check_saved_result = 0;   //作为AD检测值的存储值，即上一次播报的值。
  31          
  32          
  33          tByte vibration_count2 = 0;
  34          /*------- Public variable declarations --------------------------*/
  35          extern bit position_sensor_EN;    
  36          extern bit fell_flag;           
  37          extern bit raised_flag;       
  38          extern tByte sensor_trigger_count;  
  39          extern tByte sensor_1ststage_count; 
  40          extern bit raised_fell_once_flag;     
  41          extern bit raised_fell_flag;          
  42          extern bit EN_host_stolen_alarming;     
  43          extern bit host_stolen_alarm2_EN;      
  44          extern tByte host_stolen_alarm1_count;    
  45          extern tByte host_stolen_alarm2_count;    
  46          extern bit Host_stolen_alarming;          
  47          extern tWord sensor_3rdstage_time;      
  48          extern tByte sensor_3rdstage_effcount;    
  49          extern tByte sensor_3rdstage_count;     
  50          extern tWord sensor_3rdstage_interval;    
  51          extern tWord sensor_2ndstage_time;    
  52          extern tByte sensor_2ndstage_count;   
C51 COMPILER V9.54   OPERATION                                                             06/04/2017 11:50:54 PAGE 2   

  53          extern tWord ADC_check_result;    
  54          extern tByte wire_broken_count;   
  55          extern bit wire_broken_flag;      
  56          extern bit battery_stolen_EN;     
  57          extern tByte battery_stolen_count;
  58          extern bit sensor_3rdalarm_flag;
  59          extern tByte enable_sensor_delay_count;   
  60          extern bit Silence_Flag;
  61          extern tByte Open_action_flag;    
  62          extern tByte ID_certificated_numbers;
  63          extern bit ID_certificated_flag;      
  64          extern tByte After_IDcert_timecount;    
  65          extern bit never_alarm;
  66          extern bit IDkey_selflearn_flag1;
  67          extern bit IDkey_selflearn_flag2;
  68          extern bit IDkey_selflearn_flag3;
  69          extern bit IDkey_selflearn_flag4;
  70          extern bit IDkey_selflearn_flag5;
  71          extern bit ID_selflearning_flag;
  72          extern tByte ID_selflearning_timecount;
  73          extern tWord IDkey_selflearn_HVcount;
  74          extern tWord IDkey_selflearn_LVcount;
  75          extern tByte fell_alarm_count;
  76          extern tByte raised_alarm_count;
  77          extern tByte Check_Motobattery_count;
  78          extern bit Check_Motobattery_flag;
  79          extern tWord load_battery_result;
  80          extern bit ID_speeched_flag;
  81          extern bit slave_nearby_actioned_flag;
  82          extern bit IDkey_speech_flash;
  83          extern bit wire_broken_reset;
  84          extern tByte Stolen_alarm_reset_count;
  85          extern bit vibration_flag;
  86          extern tByte slave_nearby_count;
  87          extern bit wheeled_flag;
  88          extern bit IDkey_flash_EN;
  89          extern bit flashing_flag;
  90          extern tWord vibration_count;
  91          extern tWord wheeled_count;
  92          extern bit Just_power_up;
  93          extern bit Autolock_G;
  94          extern tWord timer0_count2;
  95          extern bit Emergency_open_G;
  96          
  97          /*-----------------------------------------
  98            slave_away_operation()
  99            
 100            operation for slave is away
 101          ------------------------------------------*/
 102          void slave_away_operation(void)
 103            { 
 104            if(Silence_Flag == 0)
 105              {
 106                #ifdef voice
                    close_lock_speech();
                    #endif
 109                
 110                ID_speech();
 111                ID_speech();
 112          
 113              #ifdef BroadcastBattery
                  Broadcast_battery();
C51 COMPILER V9.54   OPERATION                                                             06/04/2017 11:50:54 PAGE 3   

                  #endif
 116              
 117          //    Check_Motobattery_flag = 1;
 118          //    Check_Motobattery_count = 0;
 119               }
 120            // Enable_sensor(); 
 121            enable_sensor_delayEN = 1;
 122            enable_sensor_delay_count = 0;
 123            // delay time, avoid sensor trigger on.
 124            Delay(20);
 125            ID_certificated_numbers = 0;
 126          
 127            if(Silence_Flag == 1)
 128              Silence_Flag = 0;
 129            }
 130          
 131          /*----------------------------------------------------------------------
 132              slave_nearby_operation()
 133              operation for slave is nearby
 134          ----------------------------------------------------------------------*/
 135          void slave_nearby_operation(void)
 136            {
 137            slave_nearby_actioned_flag = 1;
 138            
 139            ID_speeched_flag = 0;   
 140            After_IDcert_timecount = 0;
 141            ID_certificated_flag = 0;
 142            ID_certificated_numbers = 0;    
 143          
 144            Delay_500ms();
 145            Delay_500ms();
 146            Delay_500ms();
 147            Delay_500ms();
 148          <<<<<<< HEAD
 149          //  Externalmotor = 0;
 150            
 151            if(Emergency_open_G == 0)
 152              {
 153              Generator_lock = 1;
 154              }
 155            
 156              
 157              ID_speech();
 158          =======
 159            Externalmotor = 0;
 160          >>>>>>> c6e65e4f0b4864e969ea86603842dc8b6ee1929b
 161            
 162            if(Emergency_open_G == 0)
 163              {
 164              Generator_lock = 1;
 165              }
 166              
 167            if(Silence_Flag == 0)
 168              {
 169              #ifdef voice
                    open_lock_speech();
                  #endif
 172          //    Externalmotor = 0;
 173              
 174              if(Just_power_up == 0)
 175                {
 176                #ifdef BroadcastBattery
C51 COMPILER V9.54   OPERATION                                                             06/04/2017 11:50:54 PAGE 4   

                    Broadcast_battery();
                    #endif
 179                }
 180              #ifdef voice      
                  key_rotate_on_speech();
                  #endif
 183              }
 184          
 185          
 186          /*
 187            if(Silence_Flag == 0)
 188              {
 189              open_lock_speech();
 190          //    Externalmotor = 0;
 191              if(Just_power_up == 0)
 192                verifybattery(load_battery_result);
 193              key_rotate_on_speech();
 194              }
 195            else
 196              {
 197              Delay_500ms();
 198              Delay_500ms();
 199          //    Externalmotor = 0;
 200              }
 201          */    
 202          
 203            }
 204          
 205          /*------------------------------------------------------------------
 206            InitSensor()
 207            Initialise Sensor.
 208          ------------------------------------------------------------------*/
 209          void InitSensor(void)
 210            {
 211            sensor_EN = 0;
 212            position_sensor_EN = 0;
 213            enable_sensor_delayEN = 0;  
 214            raised_sensor_detect = 1;
 215            fell_sensor_detect = 1; 
 216            }
 217            
 218          /*------------------------------------------------------------------
 219            Host_stolen_action()
 220            Determine host has been triggled 3 times, alarm action.
 221          ------------------------------------------------------------------*/
 222          void Host_stolen_action(void)
 223            {
 224            // if host has been touched 3 times, alarm 2 speeches alternantively.
 225            if(EN_host_stolen_alarming == 1)
 226              {
 227              Host_stolen_alarming = 1;
 228              
 229              #ifdef voice
                    stolen_alarm_speech1();
                  stolen_alarm_speech2();
                  #endif
 233                
 234              #ifdef Z3
                  if(wire_broken_flag == 0)
                    {
                    UART_Send_Data(ComMode_3);                                      
                    }
C51 COMPILER V9.54   OPERATION                                                             06/04/2017 11:50:54 PAGE 5   

                  else
                    {                                                                     
                    UART_Send_Data(ComMode_6);                                      
                    }
                  #endif
 244              }
 245            }
 246          
 247          /*------------------------------------------------------------------
 248            ENsensor_afterIDcert()
 249            6s After ID certificated, enable sensor. 
 250            If ID certficated 6 times, don't enable sensor.
 251          ------------------------------------------------------------------*/
 252          void ENsensor_afterIDcert(void)
 253            {
 254            if(ID_certificated_flag == 1)
 255              {
 256              // 3 tickets after ID certificated.
 257              if(++After_IDcert_timecount >= 15)
 258                {
 259                ID_certificated_flag = 0;
 260                After_IDcert_timecount = 0;     
 261                ID_certificated_numbers = 0;
 262                
 263                // 
 264                if((Open_action_flag == 0)&&(never_alarm == 0))
 265                  {
 266                  Enable_sensor();          
 267                  }       
 268                never_alarm = 0;
 269                
 270                }     
 271              }
 272            }
 273          
 274          /*------------------------------------------------------------------
 275            ENsensor_After_Close()
 276          ------------------------------------------------------------------*/
 277          void ENsensor_After_Close(void)
 278            {
 279            if((enable_sensor_delayEN == 1)&&((key_rotate == 0)||(Autolock_G == 1)))
 280              {
 281              if(++enable_sensor_delay_count >= 3)
 282                {
 283                enable_sensor_delay_count = 0;
 284                enable_sensor_delayEN = 0;
 285                if(never_alarm == 0)
 286                  Enable_sensor();
 287                }
 288              } 
 289            }
 290          
 291          /*-----------------------------------------------------------------
 292            SelfLearn_Reset()
 293            PIN22 triggles 3 times, the system enters selflearn mode
 294          ------------------------------------------------------------------*/
 295          void SelfLearn_Reset(void)
 296            { 
 297            if(ID_selflearning_flag == 1)
 298              {
 299              if(++ID_selflearning_timecount > 10)
 300                {
C51 COMPILER V9.54   OPERATION                                                             06/04/2017 11:50:54 PAGE 6   

 301                ID_selflearning_flag = 0;
 302                ID_selflearning_timecount = 0;        
 303                // Reset relatively flag and count.
 304                IDkey_selflearn_HVcount = 0;
 305                IDkey_selflearn_LVcount = 0;
 306                IDkey_selflearn_flag1 = 0;
 307                IDkey_selflearn_flag2 = 0;
 308                IDkey_selflearn_flag3 = 0;
 309                IDkey_selflearn_flag4 = 0;
 310                IDkey_selflearn_flag5 = 0;
 311                }     
 312              }
 313            }
 314          
 315          /*---------------------------------------------------
 316            Fell_Alarm_to_Slave()
 317            Send fell alarm signal to remote slave.
 318          ----------------------------------------------------*/
 319          void Fell_Alarm_to_Slave(void)
 320            {
 321            if((fell_flag==1)&&(fell_alarm_count<5))
 322              {
 323              UART_Send_Data(ComMode_5);                                      
 324              fell_alarm_count++;
 325              } 
 326            }
 327          
 328          /*----------------------------------------------------
 329            Raise_Alarm_to_Slave()
 330            Send raised alarm signal to remote slave
 331          -----------------------------------------------------*/
 332          void Raise_Alarm_to_Slave(void)
 333            {
 334            if((raised_flag==1)&&(raised_alarm_count<5))    
 335              {
 336              UART_Send_Data(ComMode_4);                                      
 337              raised_alarm_count++;
 338              }     
 339            }
 340          
 341          /*----------------------------------------------------
 342            Batstolen_Alarm_to_Slave()
 343            Send battery stolen alarm signal to remote slave
 344          -----------------------------------------------------*/
 345          void Batstolen_Alarm_to_Slave(void)
 346            {
 347            if((battery_stolen_EN == 1)&&(battery_stolen_count < 20))
 348              {
 349              UART_Send_Data(ComMode_2);                                      
 350              battery_stolen_count++;
 351              } 
 352            }
 353          
 354          /*----------------------------------------------------
 355            Disable_sensor_after_IDcert()
 356          -----------------------------------------------------*/
 357          void Disable_sensor_after_IDcert(void)
 358            {
 359            if(IDkey_speech_flash == 1)
 360              {
 361              IDkey_speech_flash = 0;
 362          
C51 COMPILER V9.54   OPERATION                                                             06/04/2017 11:50:54 PAGE 7   

 363              disable_sensor();
 364              } 
 365            }
 366          
 367          /*----------------------------------------------------
 368            Reset_after_wirebroken()
 369          -----------------------------------------------------*/
 370          void Reset_after_wirebroken(void)
 371            {
 372            if(wire_broken_reset == 1)
 373              {
 374              wire_broken_reset = 0;
 375              host_stolen_alarm1_count = 0;
 376              EN_host_stolen_alarming = 0;        
 377              Host_stolen_alarming = 0;
 378              sensor_3rdalarm_flag = 0;
 379              }
 380            }
 381          
 382          /*----------------------------------------------------
 383            Reset_after_stolen_alarming()
 384            15 tickets after stolen alarm, shut alarm.
 385          -----------------------------------------------------*/
 386          void Reset_after_stolen_alarming(void)
 387            {
 388            if(EN_host_stolen_alarming == 1)
 389              {
 390              if(++Stolen_alarm_reset_count > 2)
 391                {
 392                host_stolen_alarm1_count = 0;
 393                EN_host_stolen_alarming = 0;
 394                Host_stolen_alarming = 0;
 395                sensor_3rdalarm_flag = 0;
 396                Stolen_alarm_reset_count = 0;
 397                close_tranceiver();
 398                
 399                // 垫洪姝诲抽锛骞朵у跺ㄧ垫寮
 400                Generator_lock = 0;
 401                Externalmotor = 1;
 402                }
 403              }
 404            }
 405          
 406          /*-----------------------------------------------------
 407            Ensensor_after_slave_away()
 408          ------------------------------------------------------*/
 409          void Ensensor_after_slave_away(void)
 410            {
 411            if((vibration_flag1 == 0)&&(wheeled_flag == 0)&&(Just_power_up == 0))
 412              {
 413              if(++slave_nearby_count > 6)
 414                {
 415                slave_nearby_count = 7;
 416                slave_nearby_actioned_flag = 0;
 417                ID_certificated_flag = 0;
 418                if(never_alarm == 0)
 419                  Enable_sensor();
 420                }
 421              } 
 422            }
 423          
 424          /*----------------------------------------------------
C51 COMPILER V9.54   OPERATION                                                             06/04/2017 11:50:54 PAGE 8   

 425            Detect_selflearn_action()
 426          -----------------------------------------------------*/
 427          void Detect_selflearn_action(void)
 428            {
 429            if((key_rotate == 1)||(Emergency_open_G == 1))
 430          //  if(key_rotate == 1)
 431              {
 432              // 如果钥匙打开，则打开控制器12V电源。
 433              Lock_EN = 0;
 434          
 435              if(wire_broken == 1)
 436                {
 437                wire_broken_time += 1;
 438                if(wire_broken_time >= 6000)
 439                  {
 440                  wire_broken_time = 6001;
 441                  wire_broken_level = 0;
 442                  ID_selflearning_flag = 0;
 443                  }
 444                }
 445              else
 446                {
 447                if(wire_broken_time > 50)
 448                  {
 449                  wire_broken_time = 0;
 450                  wire_broken_level += 1;
 451                  }
 452                }
 453              
 454              if(wire_broken_level > 6)
 455                {
 456                wire_broken_level = 0;
 457                ID_selflearning_flag = 1;
 458                Self_learn_speech();
 459                }
 460              }
 461            else if((key_rotate == 0)&&(Open_action_flag == 0)&&(Emergency_open_G == 0))
 462          //  else if((key_rotate == 0)&&(Open_action_flag == 0))
 463              Lock_EN = 1;
 464          
 465              
 466            if(IDkey_flash_EN == 1)
 467              {
 468              IDkey_flash_EN = 0;
 469              flashing_flag = 1;
 470              ID_selflearning_flag = 0;
 471              
 472              Self_learn_programming();
 473              Self_learn_speech();
 474              
 475              #if (defined Z3) && (defined ID)
                    UART_Send_Data_match();
                  #endif
 478              }
 479            }
 480          
 481          /*---------------------------------------------------
 482            Detect_open_action()
 483          ---------------------------------------------------*/
 484          void Detect_open_action(void)
 485            {
 486            if(((key_rotate == 1)||(Emergency_open_G == 1))&&(Open_action_flag == 0)&&(ID_certificated_flag == 1)&&(n
C51 COMPILER V9.54   OPERATION                                                             06/04/2017 11:50:54 PAGE 9   

             -ever_alarm == 0))   
 487              {
 488              disable_sensor();
 489              Open_action_flag = 1;
 490              ID_speeched_flag = 0;
 491              
 492              After_IDcert_timecount = 0;
 493              ID_certificated_flag = 0;
 494              ID_certificated_numbers = 0;
 495              slave_nearby_actioned_flag = 1;
 496              ElecMotor_CW();
 497              slave_nearby_operation();
 498          
 499              Just_power_up = 0;
 500                  
 501              Autolock_G = 0;
 502              timer0_count2 = 0;
 503              }       
 504            }
 505          
 506          /*---------------------------------------------------
 507            Detect_close_action()
 508          ---------------------------------------------------*/
 509          void Detect_close_action(void)
 510            {
 511            if((((key_rotate == 0)&&(Emergency_open_G == 0))||(slave_nearby_actioned_flag == 0)||(Autolock_G == 1))&&
             -(Open_action_flag == 1))
 512          //  if(((key_rotate == 0)||(slave_nearby_actioned_flag == 0)||(Autolock_G == 1)||(Emergency_open_G == 0))&&
             -(Open_action_flag == 1))
 513              {
 514          <<<<<<< HEAD
 515          =======
 516              Generator_lock = 0;
 517          >>>>>>> c6e65e4f0b4864e969ea86603842dc8b6ee1929b
 518              
 519              if((vibration_flag == 0)&&(wheeled_flag == 0))
 520                {
 521                key_rotate_off_time += 1;
 522                if(key_rotate_off_time >= 500)
 523                  {
 524                  if((key_rotate == 0)||(slave_nearby_actioned_flag == 0)||(Autolock_G == 1))
 525                    {
 526                    Generator_lock = 0;
 527                    ElecMotor_ACW();
 528          
 529                    Open_action_flag = 0;
 530                    slave_away_operation();
 531                    IDkey_speech_flash = 0;
 532                    ID_speeched_flag = 0;
 533          
 534                    timer0_count2 = 0;
 535                    Emergency_open_G = 0;
 536                    }
 537                  }
 538                }
 539              }
 540            else if(key_rotate == 1)
 541              {
 542              key_rotate_off_time = 0;
 543              }
 544            }
 545          
C51 COMPILER V9.54   OPERATION                                                             06/04/2017 11:50:54 PAGE 10  

 546          /*------------------------------------------------------
 547            Detect_vibration()
 548          -------------------------------------------------------*/
 549          void Detect_vibration(void)
 550            {
 551            if((sensor_detect == 0)||(horizontal_sensor == 0)||(the3rd_sendor == 0))
 552              {
 553              if(++vibration_count2 >= 1)
 554                {
 555                vibration_count2 = 0;
 556                vibration_flag = 1;
 557                vibration_count = 0;
 558                
 559                vibration_flag1 = 1;
 560                vibration_count1 = 0; 
 561                
 562                timer0_count2 = 0;      
 563                }   
 564              }
 565            else
 566              vibration_count2 = 0;
 567              
 568              if(vibration_flag == 1)
 569              {
 570              if(++vibration_count >= 2000)
 571                {
 572                vibration_flag = 0;
 573                vibration_count = 0;
 574                }
 575              }
 576          
 577              if(vibration_flag1 == 1)
 578              {
 579              if(++vibration_count1 >= 10000)
 580                {
 581                vibration_flag1 = 0;
 582                vibration_count1 = 0;
 583                }
 584              }
 585            }
 586          
 587          /*----------------------------------------------------
 588            Detect_wheel_moving()
 589          -----------------------------------------------------*/
 590          void Detect_wheel_moving(void)
 591            {
 592            if(wheeled_rotate == 1)
 593              {
 594              wheeled_flag = 1;
 595              wheeled_count = 0;
 596              
 597              timer0_count2 = 0;
 598              }
 599            if(wheeled_flag == 1)
 600              {
 601              if(++wheeled_count >= 2000)
 602                {
 603                wheeled_flag = 0;
 604                wheeled_count = 0;
 605                   }
 606              } 
 607            }
C51 COMPILER V9.54   OPERATION                                                             06/04/2017 11:50:54 PAGE 11  

 608          
 609          /*---------------------------------------------------
 610            end of file
 611          ----------------------------------------------------*/

C51 COMPILATION COMPLETE.  0 WARNING(S),  2 ERROR(S)
