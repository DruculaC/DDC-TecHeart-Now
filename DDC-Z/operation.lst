C51 COMPILER V9.54   OPERATION                                                             09/06/2016 14:33:03 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE OPERATION
OBJECT MODULE PLACED IN .\operation.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE ..\Library\operation.c COMPACT ROM(COMPACT) OPTIMIZE
                    -(8,SPEED) BROWSE INCDIR(..\Library) DEBUG OBJECTEXTEND PRINT(.\operation.lst) TABS(3) OBJECT(.\operation.obj)

line level    source

   1          /*-------------------------------------------------------------
   2             operation.c
   3             各类操作程序
   4          --------------------------------------------------------------*/
   5          
   6          #include "main.h"
   7          #include "port.h"
   8          
   9          #include "operation.h"
  10          #include "other.h"
  11          #include "voice.h"
  12          #include "battery.h"
  13          #include "delay.h"
  14          #include "ElecMotor.h"
  15          #include "communication.h"
  16          #include "schedular.h"
  17          #include "ISP_DataFlash.h"
  18          
  19          /*------ private variable --------------------------*/
  20          bit enable_sensor_delayEN = 0;      // 延迟使能传感器的使能，不能即时使能传感器，需要过一段时间    
  21          
  22          bit sensor_EN = 0;
  23          
  24          tWord key_rotate_off_time = 0;
  25          tWord wire_broken_time = 0;
  26          tByte wire_broken_level = 0;
  27          
  28          bit vibration_flag1 = 0;
  29          tWord vibration_count1 = 0;
  30          
  31          
  32          tByte vibration_count2 = 0;
  33          /*------- Public variable declarations --------------------------*/
  34          extern bit position_sensor_EN;   
  35          extern bit fell_flag;                  
  36          extern bit raised_flag;          
  37          extern tByte sensor_trigger_count;  
  38          extern tByte sensor_1ststage_count; 
  39          extern bit raised_fell_once_flag;         
  40          extern bit raised_fell_flag;              
  41          extern bit EN_host_stolen_alarming;     
  42          extern bit host_stolen_alarm2_EN;      
  43          extern tByte host_stolen_alarm1_count;    
  44          extern tByte host_stolen_alarm2_count;    
  45          extern bit Host_stolen_alarming;             
  46          extern tWord sensor_3rdstage_time;        
  47          extern tByte sensor_3rdstage_effcount;    
  48          extern tByte sensor_3rdstage_count;       
  49          extern tWord sensor_3rdstage_interval;    
  50          extern tWord sensor_2ndstage_time;     
  51          extern tByte sensor_2ndstage_count;    
  52          extern tWord ADC_check_result;      
  53          extern tByte wire_broken_count;     
  54          extern bit wire_broken_flag;        
C51 COMPILER V9.54   OPERATION                                                             09/06/2016 14:33:03 PAGE 2   

  55          extern bit battery_stolen_EN;       
  56          extern tByte battery_stolen_count;
  57          extern bit sensor_3rdalarm_flag;
  58          extern tByte enable_sensor_delay_count;      
  59          extern bit Silence_Flag;
  60          extern tByte Open_action_flag;      
  61          extern tByte ID_certificated_numbers;
  62          extern bit ID_certificated_flag;       
  63          extern tByte After_IDcert_timecount;      
  64          extern bit never_alarm;
  65          extern bit IDkey_selflearn_flag1;
  66          extern bit IDkey_selflearn_flag2;
  67          extern bit IDkey_selflearn_flag3;
  68          extern bit IDkey_selflearn_flag4;
  69          extern bit IDkey_selflearn_flag5;
  70          extern bit ID_selflearning_flag;
  71          extern tByte ID_selflearning_timecount;
  72          extern tWord IDkey_selflearn_HVcount;
  73          extern tWord IDkey_selflearn_LVcount;
  74          extern tByte fell_alarm_count;
  75          extern tByte raised_alarm_count;
  76          extern tByte Check_Motobattery_count;
  77          extern bit Check_Motobattery_flag;
  78          extern tWord load_battery_result;
  79          extern bit ID_speeched_flag;
  80          extern bit slave_nearby_actioned_flag;
  81          extern bit IDkey_speech_flash;
  82          extern bit wire_broken_reset;
  83          extern tByte Stolen_alarm_reset_count;
  84          extern bit vibration_flag;
  85          extern tByte slave_nearby_count;
  86          extern bit wheeled_flag;
  87          extern bit IDkey_flash_EN;
  88          extern bit flashing_flag;
  89          extern tWord vibration_count;
  90          extern tWord wheeled_count;
  91          extern bit Just_power_up;
  92          extern bit Autolock_G;
  93          extern tWord timer0_count2;
  94          extern bit Emergency_open_G;
  95          
  96          /*-----------------------------------------
  97             slave_away_operation()
  98             
  99             operation for slave is away
 100          ------------------------------------------*/
 101          void slave_away_operation(void)
 102             {  
 103   1         if(Silence_Flag == 0)
 104   1            {
 105   2            close_lock_speech(); 
 106   2            load_battery_result = ADC_check_result;
 107   2            verifybattery(load_battery_result);
 108   2      
 109   2      //    Check_Motobattery_flag = 1;
 110   2      //    Check_Motobattery_count = 0;
 111   2            }
 112   1         // Enable_sensor();  
 113   1         enable_sensor_delayEN = 1;
 114   1         enable_sensor_delay_count = 0;
 115   1         // delay time, avoid sensor trigger on.
 116   1         Delay(20);
C51 COMPILER V9.54   OPERATION                                                             09/06/2016 14:33:03 PAGE 3   

 117   1         ID_certificated_numbers = 0;
 118   1      
 119   1         if(Silence_Flag == 1)
 120   1            Silence_Flag = 0;
 121   1         }
 122          
 123          /*----------------------------------------------------------------------
 124                slave_nearby_operation()
 125                operation for slave is nearby
 126          ----------------------------------------------------------------------*/
 127          void slave_nearby_operation(void)
 128             {
 129   1         slave_nearby_actioned_flag = 1;
 130   1         
 131   1         ID_speeched_flag = 0;      
 132   1         After_IDcert_timecount = 0;
 133   1         ID_certificated_flag = 0;
 134   1         ID_certificated_numbers = 0;     
 135   1      
 136   1         Delay_500ms();
 137   1         Delay_500ms();
 138   1         Delay_500ms();
 139   1         Delay_500ms();
 140   1         Externalmotor = 0;
 141   1         Generator_lock = 1;
 142   1         
 143   1         if(Silence_Flag == 0)
 144   1            {
 145   2            open_lock_speech();
 146   2            Externalmotor = 0;
 147   2            if(Just_power_up == 0)
 148   2               verifybattery(load_battery_result);
 149   2            key_rotate_on_speech();
 150   2            }
 151   1      
 152   1      
 153   1      /*
 154   1         if(Silence_Flag == 0)
 155   1            {
 156   1            open_lock_speech();
 157   1            Externalmotor = 0;
 158   1            if(Just_power_up == 0)
 159   1               verifybattery(load_battery_result);
 160   1            key_rotate_on_speech();
 161   1            }
 162   1         else
 163   1            {
 164   1            Delay_500ms();
 165   1            Delay_500ms();
 166   1            Externalmotor = 0;
 167   1            }
 168   1      */    
 169   1      
 170   1         }
 171          
 172          /*------------------------------------------------------------------
 173             InitSensor()
 174             Initialise Sensor.
 175          ------------------------------------------------------------------*/
 176          void InitSensor(void)
 177             {
 178   1         sensor_EN = 0;
C51 COMPILER V9.54   OPERATION                                                             09/06/2016 14:33:03 PAGE 4   

 179   1         position_sensor_EN = 0;
 180   1         enable_sensor_delayEN = 0; 
 181   1         raised_sensor_detect = 1;
 182   1         fell_sensor_detect = 1; 
 183   1         }
 184             
 185          /*------------------------------------------------------------------
 186             Host_stolen_action()
 187             Determine host has been triggled 3 times, alarm action.
 188          ------------------------------------------------------------------*/
 189          void Host_stolen_action(void)
 190             {
 191   1         // if host has been touched 3 times, alarm 2 speeches alternantively.
 192   1         if(EN_host_stolen_alarming == 1)
 193   1            {
 194   2            Host_stolen_alarming = 1;
 195   2            
 196   2            stolen_alarm_speech1();
 197   2            stolen_alarm_speech2();
 198   2            #ifdef Z3
                    if(wire_broken_flag == 0)
                       {
                       UART_Send_Data(ComMode_3);                                                       
                       }
                    else
                       {                                                                     
                       UART_Send_Data(ComMode_6);                                                       
                       }
                    #endif
 208   2            }
 209   1         }
 210          
 211          /*------------------------------------------------------------------
 212             ENsensor_afterIDcert()
 213             6s After ID certificated, enable sensor. 
 214             If ID certficated 6 times, don't enable sensor.
 215          ------------------------------------------------------------------*/
 216          void ENsensor_afterIDcert(void)
 217             {
 218   1         if(ID_certificated_flag == 1)
 219   1            {
 220   2            // 3 tickets after ID certificated.
 221   2            if(++After_IDcert_timecount >= 15)
 222   2               {
 223   3               ID_certificated_flag = 0;
 224   3               After_IDcert_timecount = 0;         
 225   3               ID_certificated_numbers = 0;
 226   3               
 227   3               // 
 228   3               if((Open_action_flag == 0)&&(never_alarm == 0))
 229   3                  {
 230   4                  Enable_sensor();              
 231   4                  }           
 232   3               never_alarm = 0;
 233   3               
 234   3               }        
 235   2            }
 236   1         }
 237          
 238          /*------------------------------------------------------------------
 239             ENsensor_After_Close()
 240          ------------------------------------------------------------------*/
C51 COMPILER V9.54   OPERATION                                                             09/06/2016 14:33:03 PAGE 5   

 241          void ENsensor_After_Close(void)
 242             {
 243   1         if((enable_sensor_delayEN == 1)&&((key_rotate == 0)||(Autolock_G == 1)))
 244   1            {
 245   2            if(++enable_sensor_delay_count >= 3)
 246   2               {
 247   3               enable_sensor_delay_count = 0;
 248   3               enable_sensor_delayEN = 0;
 249   3               if(never_alarm == 0)
 250   3                  Enable_sensor();
 251   3               }
 252   2            }  
 253   1         }
 254          
 255          /*-----------------------------------------------------------------
 256             SelfLearn_Reset()
 257             PIN22 triggles 3 times, the system enters selflearn mode
 258          ------------------------------------------------------------------*/
 259          void SelfLearn_Reset(void)
 260             {  
 261   1         if(ID_selflearning_flag == 1)
 262   1            {
 263   2            if(++ID_selflearning_timecount > 10)
 264   2               {
 265   3               ID_selflearning_flag = 0;
 266   3               ID_selflearning_timecount = 0;            
 267   3               // Reset relatively flag and count.
 268   3               IDkey_selflearn_HVcount = 0;
 269   3               IDkey_selflearn_LVcount = 0;
 270   3               IDkey_selflearn_flag1 = 0;
 271   3               IDkey_selflearn_flag2 = 0;
 272   3               IDkey_selflearn_flag3 = 0;
 273   3               IDkey_selflearn_flag4 = 0;
 274   3               IDkey_selflearn_flag5 = 0;
 275   3               }        
 276   2            }
 277   1         }
 278          
 279          /*---------------------------------------------------
 280             Fell_Alarm_to_Slave()
 281             Send fell alarm signal to remote slave.
 282          ----------------------------------------------------*/
 283          void Fell_Alarm_to_Slave(void)
 284             {
 285   1         if((fell_flag==1)&&(fell_alarm_count<5))
 286   1            {
 287   2            UART_Send_Data(ComMode_5);                                                       
 288   2            fell_alarm_count++;
 289   2            }  
 290   1         }
 291          
 292          /*----------------------------------------------------
 293             Raise_Alarm_to_Slave()
 294             Send raised alarm signal to remote slave
 295          -----------------------------------------------------*/
 296          void Raise_Alarm_to_Slave(void)
 297             {
 298   1         if((raised_flag==1)&&(raised_alarm_count<5))    
 299   1            {
 300   2            UART_Send_Data(ComMode_4);                                                       
 301   2            raised_alarm_count++;
 302   2            }        
C51 COMPILER V9.54   OPERATION                                                             09/06/2016 14:33:03 PAGE 6   

 303   1         }
 304          
 305          /*----------------------------------------------------
 306             Batstolen_Alarm_to_Slave()
 307             Send battery stolen alarm signal to remote slave
 308          -----------------------------------------------------*/
 309          void Batstolen_Alarm_to_Slave(void)
 310             {
 311   1         if((battery_stolen_EN == 1)&&(battery_stolen_count < 20))
 312   1            {
 313   2            UART_Send_Data(ComMode_2);                                                       
 314   2            battery_stolen_count++;
 315   2            }  
 316   1         }
 317          
 318          /*----------------------------------------------------
 319             Disable_sensor_after_IDcert()
 320          -----------------------------------------------------*/
 321          void Disable_sensor_after_IDcert(void)
 322             {
 323   1         if(IDkey_speech_flash == 1)
 324   1            {
 325   2            IDkey_speech_flash = 0;
 326   2      
 327   2            disable_sensor();
 328   2            }  
 329   1         }
 330          
 331          /*----------------------------------------------------
 332             Reset_after_wirebroken()
 333          -----------------------------------------------------*/
 334          void Reset_after_wirebroken(void)
 335             {
 336   1         if(wire_broken_reset == 1)
 337   1            {
 338   2            wire_broken_reset = 0;
 339   2            host_stolen_alarm1_count = 0;
 340   2            EN_host_stolen_alarming = 0;           
 341   2            Host_stolen_alarming = 0;
 342   2            sensor_3rdalarm_flag = 0;
 343   2            }
 344   1         }
 345          
 346          /*----------------------------------------------------
 347             Reset_after_stolen_alarming()
 348             15 tickets after stolen alarm, shut alarm.
 349          -----------------------------------------------------*/
 350          void Reset_after_stolen_alarming(void)
 351             {
 352   1         if(EN_host_stolen_alarming == 1)
 353   1            {
 354   2            if(++Stolen_alarm_reset_count > 5)
 355   2               {
 356   3               host_stolen_alarm1_count = 0;
 357   3               EN_host_stolen_alarming = 0;
 358   3               Host_stolen_alarming = 0;
 359   3               sensor_3rdalarm_flag = 0;
 360   3               Stolen_alarm_reset_count = 0;
 361   3               close_tranceiver();
 362   3               }
 363   2            }
 364   1         }
C51 COMPILER V9.54   OPERATION                                                             09/06/2016 14:33:03 PAGE 7   

 365          
 366          /*-----------------------------------------------------
 367             Ensensor_after_slave_away()
 368          ------------------------------------------------------*/
 369          void Ensensor_after_slave_away(void)
 370             {
 371   1         if((vibration_flag1 == 0)&&(wheeled_flag == 0)&&(Just_power_up == 0))
 372   1            {
 373   2            if(++slave_nearby_count > 6)
 374   2               {
 375   3               slave_nearby_count = 7;
 376   3               slave_nearby_actioned_flag = 0;
 377   3               ID_certificated_flag = 0;
 378   3               if(never_alarm == 0)
 379   3                  Enable_sensor();
 380   3               }
 381   2            }  
 382   1         }
 383          
 384          /*----------------------------------------------------
 385             Detect_selflearn_action()
 386          -----------------------------------------------------*/
 387          void Detect_selflearn_action(void)
 388             {
 389   1         if(key_rotate == 1)
 390   1            {
 391   2            // 如果钥匙打开，则打开控制器12V电源。
 392   2            Lock_EN = 0;
 393   2      
 394   2            if(wire_broken == 1)
 395   2               {
 396   3               wire_broken_time += 1;
 397   3               if(wire_broken_time >= 6000)
 398   3                  {
 399   4                  wire_broken_time = 6001;
 400   4                  wire_broken_level = 0;
 401   4                  ID_selflearning_flag = 0;
 402   4                  }
 403   3               }
 404   2            else
 405   2               {
 406   3               if(wire_broken_time > 50)
 407   3                  {
 408   4                  wire_broken_time = 0;
 409   4                  wire_broken_level += 1;
 410   4                  }
 411   3               }
 412   2            
 413   2            if(wire_broken_level > 6)
 414   2               {
 415   3               wire_broken_level = 0;
 416   3               ID_selflearning_flag = 1;
 417   3               Self_learn_speech();
 418   3               }
 419   2            }
 420   1         else if((key_rotate == 0)&&(Open_action_flag == 0))
 421   1            Lock_EN = 1;
 422   1      
 423   1            
 424   1         if(IDkey_flash_EN == 1)
 425   1            {
 426   2            IDkey_flash_EN = 0;
C51 COMPILER V9.54   OPERATION                                                             09/06/2016 14:33:03 PAGE 8   

 427   2            flashing_flag = 1;
 428   2            ID_selflearning_flag = 0;
 429   2            
 430   2            Self_learn_programming();
 431   2            
 432   2            Self_learn_speech();
 433   2            
 434   2            #if (defined Z3) && (defined ID)
                    UART_Send_Data_match();
                    #endif
 437   2            }  
 438   1         }
 439          
 440          /*---------------------------------------------------
 441             Detect_open_action()
 442          ---------------------------------------------------*/
 443          void Detect_open_action(void)
 444             {
 445   1      // if((key_rotate == 1)&&(Open_action_flag == 0)&&(ID_certificated_flag == 1)&&(never_alarm == 0))    
 446   1         if((((key_rotate == 1)&&(ID_certificated_flag == 1))||(Emergency_open_G == 1))&&(Open_action_flag == 0))
 447   1            {
 448   2            disable_sensor();
 449   2            Open_action_flag = 1;
 450   2            ID_speeched_flag = 0;
 451   2            
 452   2            After_IDcert_timecount = 0;
 453   2            ID_certificated_flag = 0;
 454   2            ID_certificated_numbers = 0;
 455   2            slave_nearby_actioned_flag = 1;
 456   2            ElecMotor_CW();
 457   2            slave_nearby_operation();
 458   2      
 459   2            Just_power_up = 0;
 460   2                  
 461   2            Autolock_G = 0;
 462   2            timer0_count2 = 0;
 463   2            }        
 464   1         }
 465          
 466          /*---------------------------------------------------
 467             Detect_close_action()
 468          ---------------------------------------------------*/
 469          void Detect_close_action(void)
 470             {
 471   1         if((((key_rotate == 0)&&(Emergency_open_G == 0))||(slave_nearby_actioned_flag == 0)||(Autolock_G == 1))&&
             -(Open_action_flag == 1))
 472   1            {
 473   2            if((vibration_flag == 0)&&(wheeled_flag == 0))
 474   2               {
 475   3               key_rotate_off_time += 1;
 476   3               if(key_rotate_off_time >= 1500)
 477   3                  {
 478   4                  if((key_rotate == 0)||(slave_nearby_actioned_flag == 0)||(Autolock_G == 1))
 479   4                     {
 480   5                     ElecMotor_ACW();
 481   5      
 482   5                     Open_action_flag = 0;
 483   5                     slave_away_operation();
 484   5                     IDkey_speech_flash = 0;
 485   5                     ID_speeched_flag = 0;      
 486   5      
 487   5                     timer0_count2 = 0;
C51 COMPILER V9.54   OPERATION                                                             09/06/2016 14:33:03 PAGE 9   

 488   5                     Emergency_open_G = 0;
 489   5                     }                       
 490   4                  }
 491   3               }
 492   2            }
 493   1         else if(key_rotate == 1)
 494   1            key_rotate_off_time = 0;
 495   1         }
 496          
 497          /*------------------------------------------------------
 498             Detect_vibration()
 499          -------------------------------------------------------*/
 500          void Detect_vibration(void)
 501             {
 502   1         if((sensor_detect == 0)||(horizontal_sensor == 0)||(the3rd_sendor == 0))
 503   1            {
 504   2            if(++vibration_count2 >= 2)
 505   2               {
 506   3               vibration_count2 = 0;
 507   3               vibration_flag = 1;
 508   3               vibration_count = 0;
 509   3               
 510   3               vibration_flag1 = 1;
 511   3               vibration_count1 = 0;   
 512   3               
 513   3               timer0_count2 = 0;         
 514   3               }     
 515   2            }
 516   1         else
 517   1            vibration_count2 = 0;
 518   1            
 519   1          if(vibration_flag == 1)
 520   1            {
 521   2            if(++vibration_count >= 4000)
 522   2               {
 523   3               vibration_flag = 0;
 524   3               vibration_count = 0;
 525   3               }
 526   2            }
 527   1      
 528   1          if(vibration_flag1 == 1)
 529   1            {
 530   2            if(++vibration_count1 >= 10000)
 531   2               {
 532   3               vibration_flag1 = 0;
 533   3               vibration_count1 = 0;
 534   3               }
 535   2            }
 536   1         }
 537          
 538          /*----------------------------------------------------
 539             Detect_wheel_moving()
 540          -----------------------------------------------------*/
 541          void Detect_wheel_moving(void)
 542             {
 543   1         if(wheeled_rotate == 1)
 544   1            {
 545   2            wheeled_flag = 1;
 546   2            wheeled_count = 0;
 547   2            
 548   2            timer0_count2 = 0;
 549   2            }
C51 COMPILER V9.54   OPERATION                                                             09/06/2016 14:33:03 PAGE 10  

 550   1         if(wheeled_flag == 1)
 551   1            {
 552   2            if(++wheeled_count >= 2000)
 553   2               {
 554   3               wheeled_flag = 0;
 555   3               wheeled_count = 0;
 556   3               }
 557   2            }  
 558   1         }
 559          
 560          /*---------------------------------------------------
 561             end of file
 562          ----------------------------------------------------*/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    789    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =      8    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
