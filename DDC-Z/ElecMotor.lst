C51 COMPILER V9.54   ELECMOTOR                                                             11/14/2016 13:39:17 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE ELECMOTOR
OBJECT MODULE PLACED IN .\ElecMotor.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE ..\Library\ElecMotor.c COMPACT ROM(COMPACT) OPTIMIZE
                    -(8,SPEED) BROWSE INCDIR(..\Library) DEBUG OBJECTEXTEND PRINT(.\ElecMotor.lst) TABS(3) OBJECT(.\ElecMotor.obj)

line level    source

   1          /*---------------------------------------------------
   2             ElecMotor.c (v1.00)
   3             
   4             All programs related to Electric Motor in Main board
   5          ---------------------------------------------------*/ 
   6          
   7          #include "main.h"
   8          #include "port.h"
   9          
  10          #include "ElecMotor.h"
  11          #include "Delay.h"
  12          #include "communication.h"
  13          
  14          /*------- Public variable declarations -----------------*/
  15          extern tByte myTxRxData[7];
  16          
  17          bit CW_flag = 0;
  18          tByte Elecmotor_duration_G;
  19          
  20          /*-------------------------------------------------------
  21             InitElecmotor()
  22          --------------------------------------------------------*/
  23          void InitElecmotor(void)
  24             {
  25   1         #ifdef Guxingzha
  26   1         ElecMotor_ACW();
  27   1         #endif
  28   1         
  29   1         #ifdef Suidongzha
              // ElecMotor_CW();
                 #endif
  32   1         }
  33             
  34          /*-------------------------------------------------------
  35             ElecMotor_CW()
  36             Electric Motor rotates clockwise.
  37          --------------------------------------------------------*/
  38          void ElecMotor_CW(void)
  39             {
  40   1         // 将P0.2, PIN25设置为准双向模式
  41   1         P0M1 &= 0xfb;
  42   1         P0M2 &= 0xfb;
  43   1         wheeled_rotate = 0;
  44   1         
  45   1         ElecMotor_code();
  46   1      
  47   1         MagentControl_1 = 1;
  48   1         MagentControl_2 = 0;
  49   1         ElecMotor_Delay_CW();
  50   1         MagentControl_1 = 1;
  51   1         MagentControl_2 = 1;
  52   1         
  53   1         wheeled_rotate = 1;
  54   1         // 将P0.2, PIN25设置为准双向模式
C51 COMPILER V9.54   ELECMOTOR                                                             11/14/2016 13:39:17 PAGE 2   

  55   1         P0M1 |= 0x04;
  56   1         P0M2 &= 0xfb;
  57   1      
  58   1      // Externalmotor = 0;
  59   1         }
  60          
  61          /*-------------------------------------------------------
  62             ElecMotor_ACW()
  63             Electric Motor rotates anticlockwise.
  64          --------------------------------------------------------*/
  65          void ElecMotor_ACW(void)
  66             {
  67   1         Externalmotor = 1;
  68   1         Lock_EN = 1;
  69   1      // Generator_lock = 0;
  70   1         
  71   1         MagentControl_1 = 0;
  72   1         MagentControl_2 = 1;
  73   1         ElecMotor_Delay_ACW();
  74   1         MagentControl_1 = 1;
  75   1         MagentControl_2 = 1;
  76   1         }
  77          
  78          /*--------------------------------------------------
  79             ElecMotor_code()
  80             send the code to Electric Motor.
  81          ---------------------------------------------------*/
  82          void ElecMotor_code(void)  
  83             {  
  84   1         tByte i,n;
  85   1         myTxRxData[0]=CmdHead;
  86   1         myTxRxData[1]=MyAddress;
  87   1         myTxRxData[2]=ComMode_1;
  88   1         
  89   1         for(i=0;i<3;i++)
  90   1            {
  91   2            for(n=0;n<8;n++)
  92   2               {
  93   3               if((myTxRxData[i]&0x80) == 0x80)
  94   3                  {
  95   4                  MagentControl_2 = 0;
  96   4                  Delay_12ms();
  97   4                  }
  98   3               else
  99   3                  {
 100   4                  MagentControl_2 = 0;
 101   4                  Delay_5ms();
 102   4                  }
 103   3               MagentControl_2 = 1; 
 104   3               myTxRxData[i] <<= 1;
 105   3               Delay_5ms();
 106   3               }
 107   2            }
 108   1         }
 109          
 110          /*--------------------------------------------------
 111             ElecMotor_closecode()
 112             send the code to Electric Motor.
 113          ---------------------------------------------------*/
 114          void ElecMotor_closecode(void)   
 115             {  
 116   1         tByte i,n;
C51 COMPILER V9.54   ELECMOTOR                                                             11/14/2016 13:39:17 PAGE 3   

 117   1         myTxRxData[0]=CmdHead;
 118   1         myTxRxData[1]=MyAddress;
 119   1         myTxRxData[2]=ComMode_2;
 120   1         
 121   1         for(i=0;i<3;i++)
 122   1            {
 123   2            for(n=0;n<8;n++)
 124   2               {
 125   3               if((myTxRxData[i]&0x80) == 0x80)
 126   3                  {
 127   4                  TXD = 0;
 128   4                  Delay_12ms();
 129   4                  }
 130   3               else
 131   3                  {
 132   4                  TXD = 0;
 133   4                  Delay_5ms();
 134   4                  }
 135   3               TXD = 1; 
 136   3               myTxRxData[i] <<= 1;
 137   3               Delay_5ms();
 138   3               }
 139   2            }
 140   1         }
 141          /*--------------------------------------------------
 142             ElecMotor_stopcode()
 143             send the code to Electric Motor.
 144          ---------------------------------------------------*/
 145          void ElecMotor_stopcode(void) 
 146             {  
 147   1         tByte i,n;
 148   1         myTxRxData[0]=CmdHead;
 149   1         myTxRxData[1]=MyAddress;
 150   1         myTxRxData[2]=ComMode_3;
 151   1         
 152   1         for(i=0;i<3;i++)
 153   1            {
 154   2            for(n=0;n<8;n++)
 155   2               {
 156   3               if((myTxRxData[i]&0x80) == 0x80)
 157   3                  {
 158   4                  TXD = 0;
 159   4                  Delay_12ms();
 160   4                  }
 161   3               else
 162   3                  {
 163   4                  TXD = 0;
 164   4                  Delay_5ms();
 165   4                  }
 166   3               TXD = 1; 
 167   3               myTxRxData[i] <<= 1;
 168   3               Delay_5ms();
 169   3               }
 170   2            }
 171   1         }
 172          
 173          /*----------------------------------------------------
 174             ElecMotor_Delay_CW()
 175             Delay program for Electric Motor.
 176          -----------------------------------------------------*/
 177          void ElecMotor_Delay_CW(void)
 178             {
C51 COMPILER V9.54   ELECMOTOR                                                             11/14/2016 13:39:17 PAGE 4   

 179   1         Delay_500ms();
 180   1         Delay_500ms();
 181   1         Delay_500ms();
 182   1         Delay_500ms();
 183   1         Delay_500ms();
 184   1         Delay_500ms();
 185   1         Delay_500ms();
 186   1      
 187   1      
 188   1         #ifdef Z3
                 Delay_500ms();
                 Delay_500ms();
                 Delay_500ms();
                 Delay_500ms();
                 Delay_500ms();
                 #endif
 195   1         
 196   1         if(ElecMotor_overcurrent == 0)
 197   1            {
 198   2            Delay_500ms();
 199   2            Delay_500ms();
 200   2            }
 201   1         }
 202          /*----------------------------------------------------
 203             ElecMotor_Delay_ACW()
 204             Delay program for Electric Motor.
 205          -----------------------------------------------------*/
 206          void ElecMotor_Delay_ACW(void)
 207             {
 208   1      
 209   1         Delay_500ms();
 210   1         Delay_500ms();
 211   1         Delay_500ms();
 212   1         
 213   1         #ifdef Guxingzha
 214   1         Delay_500ms();
 215   1         Delay_500ms();
 216   1         Delay_500ms();
 217   1         Delay_500ms();
 218   1         Delay_500ms();
 219   1         Delay_500ms();
 220   1         #endif
 221   1         
 222   1         #ifdef Z3
                 Delay_500ms();
                 #endif
 225   1      
 226   1         if(ElecMotor_overcurrent == 0)
 227   1            {
 228   2            Delay_500ms();
 229   2            Delay_500ms();
 230   2            }
 231   1         }
 232          
 233          /*----------------------------------------------------
 234             ElecMotor_test()
 235             Delay program for Electric Motor.
 236          -----------------------------------------------------*/
 237          void ElecMotor_test(void)
 238             {
 239   1         if(CW_flag == 1)
 240   1            {
C51 COMPILER V9.54   ELECMOTOR                                                             11/14/2016 13:39:17 PAGE 5   

 241   2            Elecmotor_duration_G += 1;
 242   2            if(Elecmotor_duration_G >= 10)
 243   2               {
 244   3               Elecmotor_duration_G = 0;
 245   3               ElecMotor_CW();
 246   3               CW_flag = 0;
 247   3               }
 248   2            }
 249   1         else
 250   1            {
 251   2            Elecmotor_duration_G += 1;
 252   2            if(Elecmotor_duration_G >= 10)
 253   2               {
 254   3               Elecmotor_duration_G = 0;
 255   3               ElecMotor_ACW();
 256   3               CW_flag = 1;
 257   3               }     
 258   2            }
 259   1         }
 260          
 261          /*---------------------------------------------------
 262             end of file
 263          ----------------------------------------------------*/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    417    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =      1       6
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
