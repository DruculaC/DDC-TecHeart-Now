C51 COMPILER V9.54   ELECMOTOR                                                             06/04/2017 11:50:55 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE ELECMOTOR
OBJECT MODULE PLACED IN .\ElecMotor.obj
COMPILER INVOKED BY: D:\Program Files\Keil_v5\C51\BIN\C51.EXE ..\Library\ElecMotor.c COMPACT ROM(COMPACT) OPTIMIZE(8,SPE
                    -ED) BROWSE INCDIR(..\Library) DEBUG OBJECTEXTEND PRINT(.\ElecMotor.lst) TABS(2) OBJECT(.\ElecMotor.obj)

line level    source

   1          /*---------------------------------------------------
   2            ElecMotor.c (v1.00)
   3            
   4            All programs related to Electric Motor in Main board
   5          ---------------------------------------------------*/ 
   6          
   7          #include "main.h"
   8          #include "port.h"
   9          
  10          #include "ElecMotor.h"
*** ERROR C141 IN LINE 19 OF ..\Library\ElecMotor.h: syntax error near '<<'
*** ERROR C129 IN LINE 20 OF ..\Library\ElecMotor.h: missing ';' before '=='
  11          #include "Delay.h"
  12          #include "communication.h"
  13          
  14          /*------- Public variable declarations -----------------*/
  15          extern tByte myTxRxData[7];
  16          
  17          bit CW_flag = 0;
  18          tByte Elecmotor_duration_G;
  19          bit ElecMotor_OC_flag = 0;
  20          bit ElecMotor_OC_flag2 = 0;
  21          tByte OC_count = 0;
  22          
  23          /*-------------------------------------------------------
  24            InitElecmotor()
  25          --------------------------------------------------------*/
  26          void InitElecmotor(void)
  27            {
  28            #ifdef Guxingzha
  29            ElecMotor_ACW();
  30            #endif
  31            
  32            #ifdef Suidongzha
              //  ElecMotor_CW();
                #endif
  35            }
  36            
  37          /*-------------------------------------------------------
  38            ElecMotor_CW()
  39            Electric Motor rotates clockwise.
  40          --------------------------------------------------------*/
  41          void ElecMotor_CW(void)
  42            {
  43            tByte i;
  44            
  45            lock_power = 1; 
  46              
  47            // ½«P0.2, PIN25ÉèÖÃÎª×¼Ë«ÏòÄ£Ê½
  48            P0M1 &= 0xfb;
  49            P0M2 &= 0xfb;
  50            wheeled_rotate = 0;
  51            
  52            // -----------------------------------------------
C51 COMPILER V9.54   ELECMOTOR                                                             06/04/2017 11:50:55 PAGE 2   

  53            ElecMotor_code();
  54          //  Delay_100ms();
  55          //  ElecMotor_code();
  56          
  57            MagentControl_1 = 1;
  58            MagentControl_2 = 0;
  59            ElecMotor_Delay_CW();
  60            MagentControl_1 = 1;
  61            MagentControl_2 = 1;
  62            
  63            for(i = 0; i < 7; i++)
  64              {
  65              #ifndef Locktest
  66              if(ElecMotor_OC_flag == 1)
  67                {
  68                ElecMotor_OC_flag = 0;
  69                // å…³é”2ç§’
  70                Delay_100ms();
  71                MagentControl_1 = 0;
  72                MagentControl_2 = 1;
  73                Delay_500ms();Delay_500ms();Delay_500ms();Delay_500ms();
  74                MagentControl_1 = 1;
  75                MagentControl_2 = 1;
  76                // å†æ¬¡å¼€é”
  77                Delay_100ms();Delay_100ms();
  78                ElecMotor_code();
  79                MagentControl_1 = 1;
  80                MagentControl_2 = 0;
  81                ElecMotor_Delay_CW();
  82                MagentControl_1 = 1;
  83                MagentControl_2 = 1;      
  84                }
  85              #endif
  86              
  87              #ifdef Locktest
                  if(OC_count >= 1)
                    Externalmotor = 0;
                  #endif
  91              }
  92            
  93            
  94            wheeled_rotate = 1;
  95            // ½«P0.2, PIN25ÉèÖÃÎª×¼Ë«ÏòÄ£Ê½
  96            P0M1 |= 0x04;
  97            P0M2 &= 0xfb;
  98            
  99            ElecMotor_OC_flag = 0;
 100          
 101            Externalmotor = 1;
 102            
 103            lock_power = 0;
 104            }
 105          
 106          /*-------------------------------------------------------
 107            ElecMotor_ACW()
 108            Electric Motor rotates anticlockwise.
 109          --------------------------------------------------------*/
 110          void ElecMotor_ACW(void)
 111            {
 112            tByte i;
 113            lock_power = 1;
 114              
C51 COMPILER V9.54   ELECMOTOR                                                             06/04/2017 11:50:55 PAGE 3   

 115            Externalmotor = 1;
 116            Lock_EN = 1;
 117          //  Generator_lock = 0;
 118            
 119            ElecMotor_code(); 
 120            MagentControl_1 = 0;
 121            MagentControl_2 = 0;
 122            Delay_100ms();
 123          
 124            MagentControl_1 = 0;
 125            MagentControl_2 = 1;
 126            ElecMotor_Delay_ACW();
 127            MagentControl_1 = 1;
 128            MagentControl_2 = 1;
 129            
 130            ElecMotor_OC_flag2 = 0;
 131          
 132            for(i = 0; i < 7; i++)
 133              {
 134              #ifndef Locktest
 135              if(ElecMotor_OC_flag == 1)
 136                {
 137                ElecMotor_OC_flag = 0;
 138                // å¼€é”2ç§’
 139                Delay_100ms();
 140                ElecMotor_code();
 141                MagentControl_1 = 1;
 142                MagentControl_2 = 0;
 143                Delay_500ms();Delay_500ms();Delay_500ms();Delay_500ms();
 144                MagentControl_1 = 1;
 145                MagentControl_2 = 1;
 146                // å†æ¬¡å…³é”
 147                Delay_100ms();
 148                MagentControl_1 = 0;
 149                MagentControl_2 = 1;
 150                ElecMotor_Delay_ACW();
 151                MagentControl_1 = 1;
 152                MagentControl_2 = 1;
 153                }
 154              #endif
 155              
 156              #ifdef Locktest
                  if(OC_count >= 1)
                    Externalmotor = 0;
                  #endif
 160              }
 161            
 162            ElecMotor_OC_flag = 0;
 163              
 164              lock_power = 0;
 165            }
 166          
 167          /*--------------------------------------------------
 168            ElecMotor_code()
 169            send the code to Electric Motor.
 170          ---------------------------------------------------*/
 171          void ElecMotor_code(void) 
 172            { 
 173            tByte i,n;
 174            myTxRxData[0]=CmdHead;
 175            myTxRxData[1]=MyAddress;
 176            myTxRxData[2]=ComMode_1;
C51 COMPILER V9.54   ELECMOTOR                                                             06/04/2017 11:50:55 PAGE 4   

 177            
 178            for(i=0;i<3;i++)
 179              {
 180              for(n=0;n<8;n++)
 181                {
 182                if((myTxRxData[i]&0x80) == 0x80)
 183                  {
 184                  MagentControl_2 = 0;
 185                  Delay_12ms();
 186                  }
 187                else
 188                  {
 189                  MagentControl_2 = 0;
 190                  Delay_5ms();
 191                  }
 192                MagentControl_2 = 1;  
 193                myTxRxData[i] <<= 1;
 194                Delay_5ms();
 195                }
 196              }
 197            }
 198          
 199          /*--------------------------------------------------
 200            ElecMotor_closecode()
 201            send the code to Electric Motor.
 202          ---------------------------------------------------*/
 203          void ElecMotor_closecode(void)  
 204            { 
 205            tByte i,n;
 206            myTxRxData[0]=CmdHead;
 207            myTxRxData[1]=MyAddress;
 208            myTxRxData[2]=ComMode_2;
 209            
 210            for(i=0;i<3;i++)
 211              {
 212              for(n=0;n<8;n++)
 213                {
 214                if((myTxRxData[i]&0x80) == 0x80)
 215                  {
 216                  TXD = 0;
 217                  Delay_12ms();
 218                  }
 219                else
 220                  {
 221                  TXD = 0;
 222                  Delay_5ms();
 223                  }
 224                TXD = 1;  
 225                myTxRxData[i] <<= 1;
 226                Delay_5ms();
 227                }
 228              }
 229            }
 230          /*--------------------------------------------------
 231            ElecMotor_stopcode()
 232            send the code to Electric Motor.
 233          ---------------------------------------------------*/
 234          void ElecMotor_stopcode(void) 
 235            { 
 236            tByte i,n;
 237            myTxRxData[0]=CmdHead;
 238            myTxRxData[1]=MyAddress;
C51 COMPILER V9.54   ELECMOTOR                                                             06/04/2017 11:50:55 PAGE 5   

 239            myTxRxData[2]=ComMode_3;
 240            
 241            for(i=0;i<3;i++)
 242              {
 243              for(n=0;n<8;n++)
 244                {
 245                if((myTxRxData[i]&0x80) == 0x80)
 246                  {
 247                  TXD = 0;
 248                  Delay_12ms();
 249                  }
 250                else
 251                  {
 252                  TXD = 0;
 253                  Delay_5ms();
 254                  }
 255                TXD = 1;  
 256                myTxRxData[i] <<= 1;
 257                Delay_5ms();
 258                }
 259              }
 260            }
 261          
 262          /*----------------------------------------------------
 263            ElecMotor_Delay_CW()
 264            Delay program for Electric Motor.
 265          -----------------------------------------------------*/
 266          void ElecMotor_Delay_CW(void)
 267            {
 268            tWord zz;
 269            
 270            Delay_100ms();  Delay_100ms();Delay_100ms();  Delay_100ms();
 271            
 272          
 273            for(zz = 0; zz < 35; zz++)
 274              {
 275              if(ElecMotor_overcurrent == 1)
 276                ElecMotor_OC_flag = 1;
 277              
 278              if(ElecMotor_OC_flag == 0)
 279                Delay_10ms();
 280              }
 281            
 282            if(ElecMotor_OC_flag == 0)
 283              {
 284              Delay_500ms();
 285              #ifdef Old_lock 
 286              Delay_500ms();
 287              Delay_500ms();Delay_500ms();
 288              Delay_500ms();Delay_500ms();Delay_500ms();
 289              #endif
 290              }
 291          
 292          /*  for(zz = 0; zz < 200; zz++)
 293              {
 294              if(ElecMotor_overcurrent == 1)
 295                ElecMotor_OC_flag = 1;
 296              
 297              if(ElecMotor_OC_flag == 0)
 298                Delay_10ms();
 299              }
 300          */  
C51 COMPILER V9.54   ELECMOTOR                                                             06/04/2017 11:50:55 PAGE 6   

 301          //  Delay_500ms();
 302          //  Delay_500ms();
 303          //  Delay_500ms();
 304          //  Delay_500ms();
 305          //  Delay_500ms();
 306          
 307          
 308          /*  #ifdef Z3
 309            Delay_500ms();
 310            Delay_500ms();
 311            Delay_500ms();
 312            Delay_500ms();
 313            Delay_500ms();
 314            #endif
 315          */
 316            
 317            
 318            if(ElecMotor_OC_flag == 1)
 319              OC_count += 1;
 320            }
 321          /*----------------------------------------------------
 322            ElecMotor_Delay_ACW()
 323            Delay program for Electric Motor.
 324          -----------------------------------------------------*/
 325          void ElecMotor_Delay_ACW(void)
 326            {
 327            tWord zz;
 328          
 329          //  Delay_500ms();
 330          //  Delay_500ms();
 331          //  Delay_500ms();
 332            
 333            Delay_100ms();  Delay_100ms();Delay_100ms();Delay_100ms();
 334            
 335            
 336            for(zz = 0; zz < 35; zz++)
 337              {
 338              if(ElecMotor_overcurrent == 1)
 339                ElecMotor_OC_flag = 1;
 340              
 341              if(ElecMotor_OC_flag == 0)
 342                Delay_10ms();
 343              }
 344            
 345            if(ElecMotor_OC_flag == 0)
 346              {
 347              Delay_500ms();
 348              #ifdef Old_lock
 349              Delay_500ms();
 350              Delay_500ms();Delay_500ms();Delay_500ms();Delay_500ms();
 351              //Delay_500ms();Delay_500ms();Delay_500ms();
 352              #endif
 353              }
 354          
 355          /*  for(zz = 0; zz < 300; zz++)
 356              {
 357              if(ElecMotor_overcurrent == 1)
 358                ElecMotor_OC_flag = 1;
 359              
 360              if(ElecMotor_OC_flag == 0)
 361                Delay_10ms();
 362              }
C51 COMPILER V9.54   ELECMOTOR                                                             06/04/2017 11:50:55 PAGE 7   

 363          */
 364          //  #ifdef Guxingzha
 365          //  Delay_500ms();
 366          //  Delay_500ms();
 367          //  #endif
 368            
 369            #ifdef Z3
                Delay_500ms();
                #endif
 372          
 373            if(ElecMotor_OC_flag == 1)
 374              OC_count += 1;
 375          
 376          /*  if(ElecMotor_overcurrent == 0)
 377              {
 378              Delay_500ms();
 379              Delay_500ms();
 380              Delay_500ms();
 381              Delay_500ms();
 382              Delay_500ms();
 383              Delay_500ms();
 384              }
 385          */
 386            }
 387          
 388          /*---------------------------------------------------
 389            end of file
 390          ----------------------------------------------------*/

C51 COMPILATION COMPLETE.  0 WARNING(S),  2 ERROR(S)
